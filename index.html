<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CARE & TAX SERVICES – Federal Refund Estimator (2025)</title>
  <style>
    :root{
      --mint:#2bb7a8;
      --mint-200:#c8f1ec;
      --mint-100:#e9fbf8;
      --text:#233236;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(0,0,0,.08);
      --radius:14px;
      --gap:12px;
      --footerH:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
      background:linear-gradient(180deg,var(--mint-100),#e8faf7);
      color:var(--text);
      line-height:1.35;
      padding-bottom: calc(var(--footerH) + 22px);
    }
    header{ padding:24px 16px 8px; text-align:center; }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    h2{margin:6px 0 12px;font-size:18px;font-weight:600;color:#2a4a4f}
    .muted{color:#5a6d72;font-size:14px}

    .topbar{
      max-width:1200px;margin:0 auto;padding:0 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .topbar .mini{font-size:13px;color:#2a4a4f;font-weight:800;letter-spacing:.2px}

    .progress-wrap{max-width:980px;margin:10px auto 8px auto;padding:0 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .progress-label{font-size:13px;color:#2a4a4f;min-width:120px;text-align:right}
    .progress{
      position:relative;flex:1;height:8px;border-radius:999px;background:#d9f4f0;overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
    }
    .progress>div{height:100%;background:var(--mint);width:0%;transition:width .35s ease}

    .wrap{max-width:1200px;margin:0 auto;padding:8px 16px 24px 16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .title{margin:0 0 10px;font-size:20px}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap)}

    .info{background:#f7fbfc;border:1px dashed #b8dadd;border-radius:12px;padding:12px;color:#34565d}
    .banner{
      background:#e9faf7;border:1px solid #bfece6;border-radius:12px;padding:12px;
      display:flex;gap:10px;align-items:flex-start;color:#0f4f49
    }
    .banner strong{white-space:nowrap}
    .pillline{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;
      font-size:13px;color:#1a4f49;font-weight:800;margin:8px 0 0;
    }
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      background:#ffffff;border:1px solid #bfece6;border-radius:999px;padding:6px 10px;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
    }
    .pill b{color:#0e4b45}

    label{font-size:14px;font-weight:800}
    input[type="text"],input[type="number"],select{
      width:100%;padding:12px 12px;border:1px solid #cfd9dc;border-radius:12px;font-size:16px;outline:0;
      background:#fff;transition:box-shadow .15s,border-color .15s;
    }
    input:focus,select:focus{box-shadow:0 0 0 3px #a8efe7;border-color:#2bb7a8}
    .help{font-size:13px;color:#6c8187}
    .error{font-size:13px;color:#a72a2a;margin-top:2px}
    .money{ text-align:right }

    .radio-group{display:grid;grid-template-columns:1fr;gap:10px}
    .radio-option{
      display:flex;gap:12px;align-items:center;
      padding:12px 12px;border:1px solid #d9e6e8;border-radius:14px;cursor:pointer;
      background:#ffffff;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
    }
    .radio-option input{margin:0;transform:scale(1.1)}

    .btn{
      appearance:none;border:0;border-radius:999px;padding:14px 18px;font-weight:950;cursor:pointer;
      transition:transform .02s ease, background .15s, color .15s, box-shadow .15s;outline:0;
      letter-spacing:.2px;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--mint);color:#fff;box-shadow:0 8px 20px rgba(43,183,168,.25)}
    .btn.primary:hover{background:#23a99b}
    .btn.secondary{background:#f0f8f7;color:#13524b;border:2px solid #bfece6}
    .btn.small{padding:10px 12px;font-size:13px}
    .btn.link{background:transparent;color:#17655c;text-decoration:underline;padding:6px 0;border-radius:6px;font-weight:900}

    .footer-nav{
      position:fixed;left:0;right:0;bottom:0;background:#fbfffe;border-top:1px solid #d9ece9;
      display:flex;gap:10px;justify-content:space-between;padding:12px 14px;z-index:50;
      min-height: var(--footerH);
      box-shadow:0 -10px 24px rgba(0,0,0,.05);
    }
    .footer-nav .left,.footer-nav .right{display:flex;gap:10px;align-items:center}
    .footer-nav .left{min-width:110px}
    .footer-nav .right{justify-content:flex-end;flex:1}
    .footer-nav button{min-width:110px}

    .grid-desktop{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1024px){
      .wrap{grid-template-columns:minmax(0,760px) 1fr}
      .sidebar{position:sticky;top:12px;align-self:start}
      body{padding-bottom: calc(var(--footerH) + 26px);}
    }

    .totals-head{display:flex;justify-content:space-between;align-items:center}
    .toggle{background:#e9faf7;border:1px solid #bfece6;color:#0e4b45;border-radius:10px;padding:8px 10px;font-weight:950;cursor:pointer}
    .totals-body{margin-top:10px}
    .totals-grid{display:grid;grid-template-columns:1fr auto;gap:8px;font-size:14px}
    .kpi{font-weight:950}

    .drawer{display:block}
    @media(max-width:1023px){
      .drawer.collapsed .totals-body{display:none}
    }

    .section{border:1px solid #e6eff1;border-radius:14px;padding:12px}
    .section-title{margin:0 0 8px;font-size:15px;color:#21484d;font-weight:950}
    .stack{display:flex;flex-direction:column;gap:14px}

    .w2-row{border:1px solid #e6eff1;border-radius:14px;padding:12px;background:#ffffff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:720px){
      .grid2,.grid3{grid-template-columns:1fr}
    }

    .chip{display:inline-block;background:#e7faf7;border:1px solid #bfece6;border-radius:999px;padding:4px 10px;font-size:12px;color:#0d4f48;margin-right:6px;font-weight:900}
    canvas{max-width:100%;background:#fff;border-radius:12px;border:1px solid #e5eeee}
    .space-between{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mb0{margin-bottom:0}
    .big-cta{width:100%;padding:16px 18px;font-size:16px}

    .mini-q{
      display:flex;flex-direction:column;gap:10px;
      padding:12px;border-radius:14px;border:1px solid #e6eff1;background:#fbfffe;
    }
    .mini-q b{color:#21484d}

    /* ✅ Preview fields: clearly NOT editable + green when filled */
    .preview-input{
      background:#f6fbfa !important;
      border:1px solid #d6e7e4 !important;
      color:#234 !important;
      font-weight:950;
      cursor:default;
    }
    .preview-input.filled{
      background:#e8fbf2 !important;
      border-color:#2bb7a8 !important;
      box-shadow:0 0 0 3px rgba(43,183,168,.18);
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <button class="btn secondary" id="topBackBtn" type="button" style="padding:10px 14px;border-radius:999px">← Back</button>
      <div class="mini">Tax Estimator</div>
    </div>
    <h1>CARE & TAX SERVICES – Stone Mtn</h1>
    <h2>Federal Refund Estimator (2025)</h2>
    <div class="muted">Georgia clients • Federal estimate only (no state taxes)</div>
  </header>

  <div class="progress-wrap" aria-live="polite">
    <div class="progress-label"><span id="stepText">Step 1 of 1</span></div>
    <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
  </div>

  <main class="wrap" id="app" aria-live="polite">
    <section id="mainCol" class="grid-desktop"></section>
    <aside id="sidebar" class="sidebar">
      <div class="card drawer collapsed" id="totalsDrawer" aria-label="Running Totals">
        <div class="totals-head">
          <strong>Running Totals</strong>
          <button class="toggle" id="toggleTotals" aria-expanded="false" type="button">Show</button>
        </div>
        <div class="totals-body" id="totalsBody">
          <div class="totals-grid">
            <div>W-2 Wages</div><div class="kpi" id="rtWages">$0</div>
            <div>Withholding</div><div class="kpi" id="rtWh">$0</div>
            <div>AGI (preview)</div><div class="kpi" id="rtAGI">$0</div>
            <div>Std Deduction</div><div class="kpi" id="rtStdDed">$0</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <div class="footer-nav" id="footerNav">
    <div class="left">
      <button class="btn secondary" id="backBtn" type="button">Back</button>
    </div>
    <div class="right">
      <button class="btn secondary" id="startOverBtn" type="button">Start Over</button>
      <button class="btn primary" id="nextBtn" type="button">Next</button>
    </div>
  </div>

  <script>
  const CONFIG_2025 = {
    stdDeduction: { single:15000, mfj:30000, mfs:15000, hoh:22500, qw:30000 },
    ageAddOn: { single:2000, hoh:2000, mfj:1600, mfs:1600, qw:1600 },
    brackets: {
      single: [[11925,.10],[48475,.12],[103350,.22],[197300,.24],[250525,.32],[626350,.35],[Infinity,.37]],
      mfj:   [[23850,.10],[96950,.12],[206700,.22],[394600,.24],[501050,.32],[751600,.35],[Infinity,.37]],
      mfs:   [[11925,.10],[48475,.12],[103350,.22],[197300,.24],[250525,.32],[375800,.35],[Infinity,.37]],
      hoh:   [[17000,.10],[64850,.12],[103350,.22],[197300,.24],[250500,.32],[626350,.35],[Infinity,.37]],
      qw:    [[23850,.10],[96950,.12],[206700,.22],[394600,.24],[501050,.32],[751600,.35],[Infinity,.37]],
    },
    ctc: {
      perChild: 2000,
      refundableCapPerChild: 1700,
      phaseoutThreshold: { single:200000, mfs:100000, hoh:200000, qw:200000, mfj:400000 },
      phaseoutPer1000: 50,
      earnedIncomeThreshold: 2500
    },
    eitc: {
      investmentIncomeLimit: 11950,
      params: {
        0: { phaseIn:.0765, earnedMax:8490,  max:649,  phaseOutRate:.0765, start:{single:10620, hoh:10620, qw:10620, mfj:17570, mfs:0} },
        1: { phaseIn:.34,   earnedMax:12770, max:4328, phaseOutRate:.1598, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
        2: { phaseIn:.40,   earnedMax:17880, max:7152, phaseOutRate:.2106, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
        3: { phaseIn:.45,   earnedMax:17880, max:8046, phaseOutRate:.2106, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
      }
    },
    aotc: {
      phaseout: { single:[80000,90000], hoh:[80000,90000], mfs:[0,0], mfj:[160000,180000], qw:[160000,180000] },
      refundableRate: 0.40,
      refundableCapPerStudent: 1000,
      perStudentMax: 2500
    },
    adjustments: { iraLimit: 7000, studentLoanInterestCap: 2500 }
  };

  const LS_KEY = "caretax_estimator_2025_v4_interview";
  const defaultState = () => ({
    year: 2025,
    filingStatus: null,
    ages: { taxpayer:null, spouse:null },
    work: { hasW2Job: null, jobCount: 1 },
    ui: { enterAdjustments: false },
    w2s: [{
      wages: 0,
      fedWh: 0,
      estimateW2: false,
      est: { payType:"hourly", hourly:0, hoursPerWeek:0, weeks:0, annualSalary:0, calcWages:0 },
      estimateWhIfBlank: true,
      whEst: { payFreq:"biweekly", claimDeps:"no", depCount:0, extraPerPay:0, estimatedAnnual:0 },
      ui: { hasW2Form: null, knowsBox2: null, wantsEstBox2: null }
    }],
    adjustments: { iraDeduction:0, studentLoanInterest:0 },
    interview: {
      hasDependents: null,
      kidsHaveSSN: null,
      livedHalfCount: 0,
      under17Count: 0,
      eitcChildren: 0,
      investmentIncome: 0,
      paidTuition: null,
      studentCount: 0,
      students: [{ tuitionNet:0, yearsClaimed:0, halfTime:true, felony:false }]
    },
    stepPlan: [],
    currentStepIndex: 0
  });

  let state = loadState();

  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY));
      if(!s || typeof s !== "object") return defaultState();
      const base = defaultState();
      return deepMerge(base, s);
    }catch(e){ return defaultState(); }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function resetState(){
    localStorage.removeItem(LS_KEY);
    state = defaultState();
    rebuildStepPlan();
    saveState();
    render();
  }
  function deepMerge(base, incoming){
    if(typeof base !== 'object' || base === null) return incoming;
    const out = Array.isArray(base) ? [...base] : {...base};
    for(const k in base){
      if(incoming && Object.prototype.hasOwnProperty.call(incoming,k)){
        if(typeof base[k] === 'object' && base[k] !== null){
          out[k] = deepMerge(base[k], incoming[k]);
        }else out[k] = incoming[k];
      }
    }
    for(const k in incoming){ if(!(k in out)) out[k] = incoming[k]; }
    return out;
  }

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function fmtMoney(n){ if(!isFinite(+n)) n=0; return (+n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
  function parseMoney(str){ if(str===null||str===undefined) return 0; const num = +String(str).replace(/[^\d.-]/g,""); return isFinite(num)?num:0; }
  function labelFS(code){
    return {single:"Single", mfj:"Married Filing Jointly", mfs:"Married Filing Separately", hoh:"Head of Household", qw:"Qualifying Widow(er)"}[code] || "—";
  }

  function sumWages(){ return (state.w2s||[]).reduce((a,w)=>a + (+effectiveWages(w)||0), 0); }
  function sumWithholding(){ return (state.w2s||[]).reduce((a,w)=>a + (+effectiveWithholding(w)||0), 0); }

  function effectiveWages(w){
    if(!w) return 0;
    const direct = +w.wages||0;
    if(direct>0) return direct;
    if(w.estimateW2){ return +w.est.calcWages||0; }
    return 0;
  }
  function effectiveWithholding(w){
    if(!w) return 0;
    const box2 = +w.fedWh||0;
    if(box2>0) return box2;
    if(w.estimateWhIfBlank && (+w.whEst.estimatedAnnual||0) > 0){
      return +w.whEst.estimatedAnnual||0;
    }
    return 0;
  }

  function calcStandardDeduction(){
    const status = state.filingStatus || "single";
    const base = CONFIG_2025.stdDeduction[status] || 0;
    const t65 = +state.ages.taxpayer>=65;
    const s65 = (status==="mfj") ? (+state.ages.spouse>=65) : false;
    const addPer = CONFIG_2025.ageAddOn[status] || CONFIG_2025.ageAddOn.single || 0;
    const add = (t65?addPer:0) + (s65?addPer:0);
    return base + add;
  }

  function calcTax(taxableIncome, filingStatus){
    let tax = 0;
    let prev = 0;
    const brackets = CONFIG_2025.brackets[filingStatus] || CONFIG_2025.brackets.single;
    const income = Math.max(0, taxableIncome);
    for(const [limit, rate] of brackets){
      const amt = Math.min(income, limit - prev);
      if(amt>0) tax += amt * rate;
      prev = limit;
      if(income <= limit) break;
    }
    return Math.round(tax);
  }

  function calcAGI(){
    const wages = sumWages();
    const ira = clamp(+state.adjustments.iraDeduction||0, 0, CONFIG_2025.adjustments.iraLimit);
    const sli = clamp(+state.adjustments.studentLoanInterest||0, 0, CONFIG_2025.adjustments.studentLoanInterestCap);
    return Math.round(Math.max(0, wages - ira - sli));
  }

  function calcCTC({MAGI, filingStatus, eligibleUnder17, earnedIncome, taxBeforeCredits}){
    const cfg = CONFIG_2025.ctc;
    const ssnOk = state.interview.kidsHaveSSN === "yes";
    if(!ssnOk) return { nonrefundable:0, refundable:0 };

    const baseCredit = (eligibleUnder17||0) * cfg.perChild;
    const threshold = cfg.phaseoutThreshold[filingStatus] || cfg.phaseoutThreshold.single;

    const phaseout = Math.max(0, Math.ceil(Math.max(0, MAGI - threshold)/1000) * cfg.phaseoutPer1000);
    const afterPhase = Math.max(0, baseCredit - phaseout);

    const nonref = Math.min(afterPhase, taxBeforeCredits);
    const remaining = Math.max(0, afterPhase - nonref);

    const earnedExcess = Math.max(0,(earnedIncome||0) - cfg.earnedIncomeThreshold);
    const actcMaxByIncome = Math.round(earnedExcess * 0.15);
    const actcCap = (eligibleUnder17||0) * cfg.refundableCapPerChild;
    const refundable = Math.min(remaining, actcCap, actcMaxByIncome);

    return { nonrefundable: nonref, refundable: refundable };
  }

  function calcEITC(earnedIncome, AGI, filingStatus, qualChildren, investmentIncome){
    if(filingStatus==="mfs") return 0;
    if((investmentIncome||0) > CONFIG_2025.eitc.investmentIncomeLimit) return 0;

    const n = Math.max(0, Math.min(3, +qualChildren||0));
    const p = CONFIG_2025.eitc.params[n];
    if(!p) return 0;

    const income = Math.min(earnedIncome||0, AGI||0);

    const phaseInAmt = Math.min(income, p.earnedMax);
    const phaseInCredit = phaseInAmt * p.phaseIn;
    const maxCredit = Math.min(p.max, phaseInCredit);

    const start = (p.start[filingStatus] ?? p.start.single);
    const poi = Math.max(0, (income - start) * p.phaseOutRate);

    return Math.round(Math.max(0, maxCredit - poi));
  }

  function calcAOTC(students, MAGI, filingStatus){
    const cfg = CONFIG_2025.aotc;
    const disallowedReasons = [];

    if(filingStatus==="mfs"){
      disallowedReasons.push("AOTC not allowed for Married Filing Separately.");
      return { nonrefundable:0, refundable:0, disallowedReasons };
    }

    const [lo,hi] = cfg.phaseout[filingStatus] || [0,0];
    let base=0, refundableBase=0, count=0;

    students.forEach((s,i)=>{
      if(!s) return;
      const years = +s.yearsClaimed||0;
      const tuition = Math.max(0, +s.tuitionNet||0);
      const half = !!s.halfTime;
      const fel = !!s.felony;

      if(tuition<=0){ disallowedReasons.push(`Student ${i+1}: tuition must be > 0`); return; }
      if(years>=4){ disallowedReasons.push(`Student ${i+1}: exceeds 4-year limit`); return; }
      if(!half){ disallowedReasons.push(`Student ${i+1}: must be at least half-time`); return; }
      if(fel){ disallowedReasons.push(`Student ${i+1}: felony drug conviction rule`); return; }

      const first2k = Math.min(2000, tuition);
      const next2k = Math.min(2000, Math.max(0, tuition - 2000));
      const credit = first2k + 0.25 * next2k;

      base += credit;
      refundableBase += Math.min(cfg.refundableCapPerStudent, credit * cfg.refundableRate);
      count++;
    });

    if(count===0) return { nonrefundable:0, refundable:0, disallowedReasons };

    let factor = 1;
    if(hi>lo && MAGI>lo){
      if(MAGI>=hi) factor = 0;
      else factor = (hi - MAGI)/(hi - lo);
    }

    base *= factor;
    refundableBase *= factor;

    const nonref = Math.max(0, base - refundableBase);
    const refundable = Math.max(0, refundableBase);

    return { nonrefundable: Math.round(nonref), refundable: Math.round(refundable), disallowedReasons };
  }

  function orderCredits({taxBefore}, nonrefList, refundableList){
    const nonrefTotal = Math.min(taxBefore, nonrefList.reduce((a,b)=>a+(b||0),0));
    const taxAfterNonref = Math.max(0, taxBefore - nonrefTotal);
    const refundableTotal = refundableList.reduce((a,b)=>a+(b||0),0);
    return { taxAfterNonref, refundableTotal };
  }

  const PAY_PERIODS = { weekly:52, biweekly:26, semimonthly:24, monthly:12 };

  function estimateAnnualWithholdingForW2(w){
    const wages = +effectiveWages(w)||0;
    if(wages<=0) return 0;

    const status = state.filingStatus || "single";
    const stdDed = calcStandardDeduction();
    const taxable = Math.max(0, wages - stdDed);
    let tax = calcTax(taxable, status);

    const claimDeps = (w.whEst.claimDeps||"no") === "yes";
    let depCount = claimDeps ? (+w.whEst.depCount||0) : 0;
    if(claimDeps && depCount<=0) depCount = 1;
    if(depCount>0){
      tax = Math.max(0, tax - (depCount * 500));
    }

    const extra = Math.max(0, +w.whEst.extraPerPay||0);
    const pp = PAY_PERIODS[w.whEst.payFreq||"biweekly"] || 26;

    const basePerPay = tax / pp;
    const annualExtra = extra * pp;

    return Math.round((basePerPay * pp) + annualExtra);
  }

  function computeResults(){
    const wages = sumWages();
    const withholding = sumWithholding();

    const AGI = calcAGI();
    const stdDed = calcStandardDeduction();
    const taxable = Math.max(0, AGI - stdDed);
    const taxBefore = calcTax(taxable, state.filingStatus||"single");

    const earnedIncome = wages;
    const MAGI = AGI;

    const ctc = (state.interview.hasDependents==="yes" && (+state.interview.under17Count||0)>0)
      ? calcCTC({
          MAGI,
          filingStatus: state.filingStatus||"single",
          eligibleUnder17: +state.interview.under17Count||0,
          earnedIncome,
          taxBeforeCredits: taxBefore
        })
      : {nonrefundable:0, refundable:0};

    const eitc = (state.filingStatus!=="mfs")
      ? calcEITC(
          earnedIncome,
          AGI,
          state.filingStatus||"single",
          +state.interview.eitcChildren||0,
          +state.interview.investmentIncome||0
        )
      : 0;

    const sc = clamp(+state.interview.studentCount||0, 0, 3);
    const students = (state.interview.students||[]).slice(0, sc).map(s=>({
      tuitionNet:+s.tuitionNet||0,
      yearsClaimed:clamp(+s.yearsClaimed||0,0,3),
      halfTime:(s.halfTime===true || s.halfTime==="true"),
      felony:(s.felony===true || s.felony==="true")
    }));
    const aotc = (state.interview.paidTuition==="yes" && sc>0)
      ? calcAOTC(students, MAGI, state.filingStatus||"single")
      : {nonrefundable:0, refundable:0, disallowedReasons:[]};

    const ord = orderCredits(
      { taxBefore },
      [ctc.nonrefundable, aotc.nonrefundable],
      [ctc.refundable, aotc.refundable, eitc]
    );

    const totalPayments = withholding + ord.refundableTotal;
    const finalAmount = totalPayments - ord.taxAfterNonref;

    return {
      wages, withholding, AGI, stdDed, taxable, taxBefore,
      ctc, eitc, aotc,
      taxAfterNonref: ord.taxAfterNonref,
      refundableTotal: ord.refundableTotal,
      totalPayments, finalAmount
    };
  }

  function rebuildStepPlan(){
    const p = ["welcome","status","w2","adjustments"];
    if(state.interview.hasDependents === "yes"){ p.push("kids"); }
    p.push("eitc");
    if(state.interview.paidTuition === "yes"){ p.push("aotc"); }
    p.push("results");

    state.stepPlan = p;
    if(state.currentStepIndex >= p.length) state.currentStepIndex = p.length - 1;
    if(state.currentStepIndex < 0) state.currentStepIndex = 0;
  }
  function currentStep(){ return state.stepPlan[state.currentStepIndex] || "welcome"; }

  function validate(step){
    const errs = [];
    const s = state;

    switch(step){
      case "welcome": break;
      case "status":
        if(!s.filingStatus) errs.push("Choose a filing status.");
        if(s.ages.taxpayer===null || isNaN(+s.ages.taxpayer) || +s.ages.taxpayer<0 || +s.ages.taxpayer>120) errs.push("Enter a valid taxpayer age.");
        if(s.filingStatus==="mfj"){
          if(s.ages.spouse===null || isNaN(+s.ages.spouse) || +s.ages.spouse<0 || +s.ages.spouse>120) errs.push("Enter a valid spouse age.");
        }
        break;

      case "w2":
        if(!["yes","no"].includes(s.work.hasW2Job)) errs.push("Please answer: Did you work a W-2 job?");
        if(s.work.hasW2Job==="yes"){
          if(!isFinite(+s.work.jobCount) || +s.work.jobCount<1) errs.push("Select how many W-2 jobs you have (at least 1).");
          if(!s.w2s.length) errs.push("Add at least one W-2.");
          s.w2s.forEach((w,i)=>{
            const hasForm = w.ui?.hasW2Form;
            if(hasForm===null) errs.push(`W-2 #${i+1}: Please answer if you have the W-2 form.`);

            const wages = +effectiveWages(w)||0;
            if(hasForm==="yes"){
              const box1raw = +w.wages||0;
              if(isNaN(box1raw) || box1raw<0) errs.push(`W-2 #${i+1}: wages must be ≥ 0`);
              if(box1raw<=0) errs.push(`W-2 #${i+1}: Enter W-2 Box 1 wages (or switch to “No” and estimate).`);
            } else if(hasForm==="no"){
              if(!w.estimateW2) errs.push(`W-2 #${i+1}: Wage estimate must be ON if you don’t have the W-2.`);
              if(wages<=0) errs.push(`W-2 #${i+1}: Enter your estimate (hourly/salary) then it will calculate live.`);
            }

            const knowsBox2 = w.ui?.knowsBox2;
            if(knowsBox2===null) errs.push(`W-2 #${i+1}: Please answer if you know Box 2 (federal withheld).`);
            if(knowsBox2==="yes"){
              const box2raw = +w.fedWh||0;
              if(isNaN(box2raw) || box2raw<0) errs.push(`W-2 #${i+1}: federal withheld must be ≥ 0`);
            } else if(knowsBox2==="no"){
              const wantsEst = w.ui?.wantsEstBox2;
              if(wantsEst===null) errs.push(`W-2 #${i+1}: Please answer if you want us to estimate Box 2.`);
            }
          });
        }
        break;

      case "adjustments":
        if(+s.adjustments.iraDeduction<0) errs.push("IRA deduction cannot be negative.");
        if(+s.adjustments.studentLoanInterest<0) errs.push("Student loan interest cannot be negative.");
        if(s.interview.hasDependents !== "yes" && s.interview.hasDependents !== "no") errs.push("Please answer the dependents question.");
        if(s.interview.paidTuition !== "yes" && s.interview.paidTuition !== "no") errs.push("Please answer the tuition question.");
        break;

      case "kids":
        if(s.interview.hasDependents === "yes"){
          if(!["yes","no"].includes(s.interview.kidsHaveSSN)) errs.push("Please answer whether the children you claim have SSNs.");
          if(+s.interview.livedHalfCount<0) errs.push("Dependents count can’t be negative.");
          if(+s.interview.under17Count<0) errs.push("Under-17 count can’t be negative.");
          if(+s.interview.under17Count > +s.interview.livedHalfCount) errs.push("Under-17 count can’t be more than dependents who lived with you more than half the year.");
        }
        break;

      case "eitc":
        if(+s.interview.investmentIncome<0) errs.push("Investment income can’t be negative.");
        if(+s.interview.eitcChildren<0) errs.push("EITC qualifying children can’t be negative.");
        break;

      case "aotc":
        if(s.interview.paidTuition === "yes"){
          const sc = clamp(+s.interview.studentCount||0, 0, 3);
          if(sc<=0) errs.push("Select the number of students (1–3).");
          for(let i=0;i<sc;i++){
            const st = (s.interview.students||[])[i];
            if(!st){ errs.push(`Student ${i+1} missing.`); continue; }
            if(+st.yearsClaimed<0 || +st.yearsClaimed>3) errs.push(`Student ${i+1}: years claimed must be 0–3.`);
            if(+st.tuitionNet<0) errs.push(`Student ${i+1}: tuition can’t be negative.`);
          }
        }
        break;

      case "results": break;
    }
    return errs;
  }

  function showErrors(list){
    const area = $("#errorArea");
    if(area){
      area.innerHTML = list.map(e=>`<div class="error">• ${e}</div>`).join("");
      area.focus();
      area.scrollIntoView({behavior:"smooth", block:"start"});
    } else alert(list.join("\n"));
  }

  function setByPath(obj, path, value){
    const parts = Array.isArray(path)?path: String(path).split(".");
    let ref = obj;
    for(let i=0;i<parts.length-1;i++){
      const k = parts[i];
      if(!(k in ref)) ref[k] = {};
      ref = ref[k];
    }
    ref[parts[parts.length-1]] = value;
  }

  function ensureW2Count(n){
    n = clamp(+n||1, 1, 8);
    state.work.jobCount = n;

    while(state.w2s.length < n){
      state.w2s.push({
        wages:0, fedWh:0, estimateW2:false,
        est:{ payType:"hourly", hourly:0, hoursPerWeek:0, weeks:0, annualSalary:0, calcWages:0 },
        estimateWhIfBlank:true,
        whEst:{ payFreq:"biweekly", claimDeps:"no", depCount:0, extraPerPay:0, estimatedAnnual:0 },
        ui:{ hasW2Form:null, knowsBox2:null, wantsEstBox2:null }
      });
    }
    if(state.w2s.length > n){
      state.w2s = state.w2s.slice(0,n);
    }
  }

  function normalizeInterviewFlags(){
    state.w2s.forEach(w=>{
      if(!w.ui) w.ui = {hasW2Form:null, knowsBox2:null, wantsEstBox2:null};

      if(w.ui.hasW2Form==="yes"){
        w.estimateW2 = false;
        w.est.calcWages = w.est.calcWages || 0;
      }
      if(w.ui.hasW2Form==="no"){
        w.estimateW2 = true;
        if(+w.wages>0) w.wages = 0;
      }

      if(w.ui.knowsBox2==="yes"){
        w.estimateWhIfBlank = false;
        w.whEst.estimatedAnnual = 0;
        w.ui.wantsEstBox2 = null;
      }
      if(w.ui.knowsBox2==="no"){
        if(+w.fedWh>0) w.fedWh = 0;
        if(w.ui.wantsEstBox2==="yes"){
          w.estimateWhIfBlank = true;
        } else if(w.ui.wantsEstBox2==="no"){
          w.estimateWhIfBlank = false;
          w.whEst.estimatedAnnual = 0;
        }
      }
    });
  }

  /* ✅ LIVE preview helpers */
  function paintPreview(el, value){
    if(!el) return;
    const v = Math.max(0, +value||0);
    el.value = fmtMoney(v);
    el.classList.toggle("filled", v > 0);
  }

  function recalcLiveW2(i){
    const w = state.w2s[i];
    if(!w) return;

    if(w.estimateW2){
      let estW = 0;
      if(w.est.payType==="hourly"){
        const hr = Math.max(0, +w.est.hourly||0);
        const hpw = Math.max(0, +w.est.hoursPerWeek||0);
        const weeks = Math.max(0, +w.est.weeks||0);
        estW = hr * hpw * weeks;
      }else{
        estW = Math.max(0, +w.est.annualSalary||0);
      }
      w.est.calcWages = Math.round(estW);
    }

    // Update previews (no render)
    paintPreview(document.getElementById("wagePreview_"+i), effectiveWages(w));
    paintPreview(document.getElementById("estWagePreview_"+i), w.est.calcWages);

    // If withholding estimator is enabled, keep Box2 preview in sync too
    if(w.estimateWhIfBlank){
      paintPreview(document.getElementById("box2Preview_"+i), +w.whEst.estimatedAnnual||0);
    }
  }

  function maybeAutoEstimateBox2(i){
    const w = state.w2s[i];
    if(!w) return;
    if(!w.estimateWhIfBlank) return;

    w.whEst.estimatedAnnual = estimateAnnualWithholdingForW2(w);
    paintPreview(document.getElementById("box2Preview_"+i), w.whEst.estimatedAnnual);
  }

  function goNext(){
    const step = currentStep();
    const errs = validate(step);
    if(errs.length){ showErrors(errs); return; }

    if(step==="status" || step==="w2" || step==="kids" || step==="eitc" || step==="adjustments"){
      rebuildStepPlan();
    }

    if(state.currentStepIndex < state.stepPlan.length-1){
      state.currentStepIndex++;
      saveState();
      render();
      window.scrollTo({top:0,behavior:"smooth"}); /* ✅ only on step change */
    }
  }
  function goBack(){
    if(state.currentStepIndex>0){
      state.currentStepIndex--;
      saveState();
      render();
      window.scrollTo({top:0,behavior:"smooth"}); /* ✅ only on step change */
    }
  }

  const mainCol = document.getElementById('mainCol');
  const stepText = document.getElementById('stepText');
  const progressBar = document.getElementById('progressBar');

  function render(){
    rebuildStepPlan();

    const total = state.stepPlan.length;
    const idx = state.currentStepIndex + 1;
    stepText.textContent = `Step ${idx} of ${total}`;
    progressBar.style.width = `${(idx-0.01)/total*100}%`;

    const step = currentStep();

    $("#backBtn").disabled = state.currentStepIndex===0;
    $("#topBackBtn").disabled = state.currentStepIndex===0;

    $("#nextBtn").style.display = (step==="results") ? "none" : "inline-flex";
    $("#backBtn").style.visibility = (step==="results") ? "hidden" : "visible";
    $("#topBackBtn").style.visibility = (step==="results") ? "hidden" : "visible";

    mainCol.innerHTML = "";
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = renderStep(step);
    mainCol.appendChild(card);

    attachHandlers(card);
    updateTotals();

    // ✅ DO NOT auto-scroll here anymore (prevents jumps while estimating)
  }

  function attachHandlers(scope){
    $$('input[data-money]', scope).forEach(el=>{
      el.addEventListener('focus', ()=>{ el.value = parseMoney(el.value); });
      el.addEventListener('blur', ()=>{
        const num = parseMoney(el.value);
        el.value = num ? num.toLocaleString() : "";
      });
      el.addEventListener('input', ()=>{
        const num = parseMoney(el.value);
        setByPath(state, el.dataset.bind, isFinite(num)?num:0);
        saveState();
        updateTotals();

        // ✅ live wage preview when typing Box 1 or salary/extra withholding
        const m = String(el.dataset.bind||"").match(/^w2s\.(\d+)\./);
        if(m){
          const i = +m[1];
          recalcLiveW2(i);

          // if they typed extra withholding, update Box2 estimate live (but only if estimator is on)
          if(String(el.dataset.bind||"").includes(".whEst.extraPerPay")){
            maybeAutoEstimateBox2(i);
            saveState();
            updateTotals();
          }
        }
      });
    });

    $$('input[type="number"]:not([data-money])', scope).forEach(el=>{
      el.addEventListener('input', ()=>{
        let v = +el.value;
        if(!isFinite(v)) v = 0;
        if(v<0) v=0;
        setByPath(state, el.dataset.bind, v);
        saveState();
        updateTotals();

        // ✅ live wage preview when typing hourly inputs
        const m = String(el.dataset.bind||"").match(/^w2s\.(\d+)\./);
        if(m){
          const i = +m[1];
          recalcLiveW2(i);
          // if dep count changed and estimator is on, keep Box2 estimate in sync
          if(String(el.dataset.bind||"").includes(".whEst.depCount")){
            maybeAutoEstimateBox2(i);
          }
        }
      });
    });

    $$('select, input[type="radio"], input[type="checkbox"]', scope).forEach(el=>{
      el.addEventListener('change', ()=>{
        // ✅ special-case pay frequency: compute estimate immediately + NO render + NO scroll jump
        const bind = String(el.dataset.bind||"");
        const payFreqMatch = bind.match(/^w2s\.(\d+)\.whEst\.payFreq$/);
        if(payFreqMatch){
          const i = +payFreqMatch[1];
          setByPath(state, bind, el.value);
          maybeAutoEstimateBox2(i);
          saveState();
          updateTotals();
          return; // ✅ stop here: no rebuild/render
        }

        if(el.type==="checkbox") setByPath(state, el.dataset.bind, el.checked);
        else if(el.type==="radio") setByPath(state, el.dataset.bind, el.value);
        else setByPath(state, el.dataset.bind, el.value);

        if(el.id==="studentCountSel"){
          const n = clamp(+el.value||0, 0, 3);
          state.interview.studentCount = n;
          while(state.interview.students.length < n) state.interview.students.push({tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false});
          if(state.interview.students.length > n) state.interview.students = state.interview.students.slice(0,n);
        }

        if(el.id==="jobCountSel"){
          ensureW2Count(+el.value||1);
        }

        if(el.dataset.bind==="work.hasW2Job"){
          if(el.value==="no"){
            state.work.jobCount = 1;
            state.w2s = [state.w2s[0] || {
              wages:0, fedWh:0, estimateW2:false,
              est:{ payType:"hourly", hourly:0, hoursPerWeek:0, weeks:0, annualSalary:0, calcWages:0 },
              estimateWhIfBlank:true,
              whEst:{ payFreq:"biweekly", claimDeps:"no", depCount:0, extraPerPay:0, estimatedAnnual:0 },
              ui:{ hasW2Form:null, knowsBox2:null, wantsEstBox2:null }
            }];
            state.w2s[0].wages = 0;
            state.w2s[0].fedWh = 0;
            state.w2s[0].estimateW2 = false;
            state.w2s[0].est.calcWages = 0;
            state.w2s[0].estimateWhIfBlank = false;
            state.w2s[0].whEst.estimatedAnnual = 0;
            state.w2s[0].ui = {hasW2Form:null, knowsBox2:null, wantsEstBox2:null};
          } else {
            if(!state.work.jobCount) state.work.jobCount = 1;
            ensureW2Count(state.work.jobCount);
          }
        }

        if(el.dataset.bind==="ui.enterAdjustments"){
          // radio returns "true"/"false" strings -> normalize to boolean
          state.ui.enterAdjustments = (String(el.value) === "true");
          if(!state.ui.enterAdjustments){
            state.adjustments.iraDeduction = 0;
            state.adjustments.studentLoanInterest = 0;
          }
        }

        if(el.dataset.bind==="interview.hasDependents" && el.value==="no"){
          state.interview.kidsHaveSSN = null;
          state.interview.livedHalfCount = 0;
          state.interview.under17Count = 0;
          state.interview.eitcChildren = 0;
        }

        if(el.dataset.bind==="interview.paidTuition" && el.value==="no"){
          state.interview.studentCount = 0;
          state.interview.students = [{tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false}];
        }

        if(String(el.dataset.bind||"").includes("w2s.") && String(el.dataset.bind||"").includes(".ui.")){
          normalizeInterviewFlags();
        }

        rebuildStepPlan();
        saveState();
        render();
      });
    });

    const addW2 = $("#addW2", scope);
    if(addW2){
      addW2.onclick = ()=>{
        state.w2s.push({
          wages:0, fedWh:0, estimateW2:false,
          est:{ payType:"hourly", hourly:0, hoursPerWeek:0, weeks:0, annualSalary:0, calcWages:0 },
          estimateWhIfBlank:true,
          whEst:{ payFreq:"biweekly", claimDeps:"no", depCount:0, extraPerPay:0, estimatedAnnual:0 },
          ui:{ hasW2Form:null, knowsBox2:null, wantsEstBox2:null }
        });
        state.work.jobCount = state.w2s.length;
        saveState();
        render();
      };
    }

    $$(".removeW2", scope).forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.dataset.idx;
        state.w2s.splice(idx,1);
        if(!state.w2s.length){
          state.w2s=[{
            wages:0, fedWh:0, estimateW2:false,
            est:{ payType:"hourly", hourly:0, hoursPerWeek:0, weeks:0, annualSalary:0, calcWages:0 },
            estimateWhIfBlank:true,
            whEst:{ payFreq:"biweekly", claimDeps:"no", depCount:0, extraPerPay:0, estimatedAnnual:0 },
            ui:{ hasW2Form:null, knowsBox2:null, wantsEstBox2:null }
          }];
        }
        state.work.jobCount = state.w2s.length;
        saveState();
        render();
      };
    });

    $$(".calcWagesBtn", scope).forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.dataset.idx;
        recalcLiveW2(idx);
        saveState();
        updateTotals();
      };
    });

    $$(".estimateBox2Btn", scope).forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.dataset.idx;
        const w = state.w2s[idx];
        if(!w) return;
        w.whEst.estimatedAnnual = estimateAnnualWithholdingForW2(w);
        paintPreview(document.getElementById("box2Preview_"+idx), w.whEst.estimatedAnnual);
        saveState();
        updateTotals();
      };
    });

    const toggle = $("#toggleTotals", scope) || $("#toggleTotals");
    if(toggle){
      toggle.onclick = ()=>{
        const d = $("#totalsDrawer");
        const collapsed = d.classList.toggle("collapsed");
        toggle.textContent = collapsed ? "Show" : "Hide";
        toggle.setAttribute("aria-expanded", String(!collapsed));
      };
    }

    const resetInline = $("[data-action='reset']", scope);
    if(resetInline){
      resetInline.onclick = (e)=>{ e.preventDefault(); resetState(); };
    }

    const startBtn = $("#startBtn", scope);
    if(startBtn){
      startBtn.onclick = (e)=>{ e.preventDefault(); goNext(); };
    }
  }

  function updateTotals(){
    const wages = sumWages();
    const wh = sumWithholding();
    const agi = calcAGI();
    const sd = calcStandardDeduction();

    $("#rtWages").textContent = fmtMoney(wages);
    $("#rtWh").textContent = fmtMoney(wh);
    $("#rtAGI").textContent = fmtMoney(agi);
    $("#rtStdDed").textContent = fmtMoney(sd);
  }

  function renderStep(step){
    switch(step){
      case "welcome":
        return `
          <h3 class="title">Welcome! Let’s estimate your federal refund.</h3>

          <div class="banner" role="note" style="justify-content:center;flex-wrap:wrap">
            <strong>CARE & TAX SERVICES</strong>
            <div class="pillline" style="width:100%">
              <span class="pill"><b>Phone:</b> 1-888-711-7206</span>
              <span class="pill"><b>Email:</b> info@caretaxservices.com</span>
              <span class="pill"><b>Address:</b> 5061 Memorial Dr, Stone Mountain, GA 30083</span>
            </div>
          </div>

          <div class="section mt12" style="background:#eefcf9;border-color:#bfece6">
            <div class="section-title">W-2 Filing Special — Only $89</div>
            <div class="help" style="font-size:13px;color:#1b5b54">
              We can file your W-2 return for just $89.
            </div>
          </div>

          <div class="section mt12">
            <div class="section-title">What you’ll need (if you have it)</div>
            <div class="mini-q">
              <div>✅ Your <b>W-2 Box 1</b> (wages)</div>
              <div>✅ Your <b>W-2 Box 2</b> (federal withheld)</div>
              <div>✅ If you don’t have it, it’s okay — we can <b>estimate</b>.</div>
            </div>
          </div>

          <div class="info mt12">
            <b>2025 only.</b> W-2 jobs only. Federal estimate only. Not tax advice.
            <div class="help mt8">This is a rough estimate. Exact refund depends on eligibility rules and exact withholding.</div>
          </div>

          <div class="mt12">
            <button class="btn primary big-cta" id="startBtn" type="button">Start</button>
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "status":
        return `
          <h3 class="title">How do you usually file?</h3>
          <div class="info">Pick the option you usually file. Then enter your age.</div>

          <div class="row mt12">
            <div class="radio-group" role="radiogroup" aria-label="Filing Status">
              ${["single","mfj","mfs","hoh","qw"].map(code=>{
                return `
                <label class="radio-option">
                  <input type="radio" data-bind="filingStatus" value="${code}" ${state.filingStatus===code?'checked':''}>
                  <span><b>${labelFS(code)}</b></span>
                </label>`;
              }).join("")}
            </div>

            <div class="grid2 mt12">
              <div>
                <label>Taxpayer age</label>
                <input type="number" min="0" max="120" data-bind="ages.taxpayer" value="${state.ages.taxpayer??''}">
                <div class="help">Used only to estimate extra standard deduction at 65+.</div>
              </div>
              ${state.filingStatus==="mfj" ? `
              <div>
                <label>Spouse age</label>
                <input type="number" min="0" max="120" data-bind="ages.spouse" value="${state.ages.spouse??''}">
                <div class="help">Only required for Married Filing Jointly.</div>
              </div>` : ""}
            </div>

            ${state.filingStatus==="mfs" ? `
              <div class="info">Note: Married Filing Separately often disqualifies or limits certain credits (like EITC and AOTC). This estimator reflects those limits.</div>
            ` : ""}
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "w2":
        const hasJob = state.work.hasW2Job;
        const showJobs = hasJob==="yes";
        const jobCount = clamp(+state.work.jobCount||1, 1, 8);

        return `
          <h3 class="title">Work & W-2 (Simple Interview)</h3>

          <div class="section">
            <div class="section-title">Question 1</div>
            <label>Did you work a job where you will get a W-2?</label>
            <div class="radio-group mt8">
              <label class="radio-option">
                <input type="radio" data-bind="work.hasW2Job" value="yes" ${hasJob==="yes"?'checked':''}>
                <span><b>Yes</b> (I worked a W-2 job)</span>
              </label>
              <label class="radio-option">
                <input type="radio" data-bind="work.hasW2Job" value="no" ${hasJob==="no"?'checked':''}>
                <span><b>No</b></span>
              </label>
            </div>
            <div class="help mt8">This estimator is for W-2 only. If you select “No”, we’ll continue with $0 wages (so it won’t crash).</div>
          </div>

          ${showJobs ? `
            <div class="section mt12">
              <div class="section-title">Question 2</div>
              <label>How many W-2 jobs do you have?</label>
              <select id="jobCountSel" data-bind="work.jobCount" class="mt8">
                ${[1,2,3,4,5].map(n=>`<option value="${n}" ${jobCount===n?'selected':''}>${n}</option>`).join("")}
              </select>
              <div class="help mt8">We will show one section for each job.</div>
            </div>

            <div class="info mt12">
              Tip: If you don’t have your W-2, choose “No” and estimate your wages.
            </div>

            <div class="stack mt12">
              ${(state.w2s||[]).slice(0, jobCount).map((w,idx)=>{
                const ui = w.ui || {hasW2Form:null, knowsBox2:null, wantsEstBox2:null};
                const calcPreview = Math.max(0, +w.est.calcWages||0);
                const whPreview = Math.max(0, +w.whEst.estimatedAnnual||0);

                const hasForm = ui.hasW2Form;
                const knowsBox2 = ui.knowsBox2;
                const wantsEst = ui.wantsEstBox2;

                const showBox1Box2 = (hasForm==="yes");
                const showWageEstimator = (hasForm==="no");

                const showBox2Field = (knowsBox2==="yes");
                const showAskWantsEst = (knowsBox2==="no");
                const showWhEstimatorUI = (knowsBox2==="no" && wantsEst==="yes");

                return `
                  <div class="w2-row">
                    <div class="space-between">
                      <div style="font-weight:950;color:#21484d">Job ${idx+1}</div>
                      <div class="help">Answer the questions → then enter only what you have.</div>
                    </div>

                    <div class="section mt12">
                      <div class="section-title">Question 3</div>
                      <label>Do you have your W-2 form for this job?</label>
                      <div class="radio-group mt8">
                        <label class="radio-option">
                          <input type="radio" data-bind="w2s.${idx}.ui.hasW2Form" value="yes" ${hasForm==="yes"?'checked':''}>
                          <span><b>Yes</b></span>
                        </label>
                        <label class="radio-option">
                          <input type="radio" data-bind="w2s.${idx}.ui.hasW2Form" value="no" ${hasForm==="no"?'checked':''}>
                          <span><b>No</b> (estimate)</span>
                        </label>
                      </div>
                    </div>

                    ${showBox1Box2 ? `
                      <div class="section mt12">
                        <div class="section-title">Enter wages (from your W-2)</div>
                        <div class="grid2">
                          <div>
                            <label>Wages (W-2 Box 1)</label>
                            <input class="money" data-money="1" data-bind="w2s.${idx}.wages" value="${(+w.wages?Number(w.wages).toLocaleString(): '')}" inputmode="numeric" placeholder="Box 1">
                            <div class="help">Enter Box 1 from your W-2.</div>
                          </div>
                          <div>
                            <label>Wages preview</label>
                            <input id="wagePreview_${idx}" class="money preview-input ${effectiveWages(w)>0?'filled':''}" type="text" value="${fmtMoney(effectiveWages(w))}" readonly>
                            <div class="help">Updates live as you type.</div>
                          </div>
                        </div>
                      </div>
                    ` : ""}

                    ${showWageEstimator ? `
                      <div class="section mt12">
                        <div class="section-title">Estimate wages</div>
                        <div class="help">If you don’t have the W-2, estimate your wages for the year.</div>

                        <div class="grid2 mt12">
                          <div>
                            <label>Pay type</label>
                            <select data-bind="w2s.${idx}.est.payType">
                              <option value="hourly" ${w.est.payType==="hourly"?'selected':''}>Hourly</option>
                              <option value="salary" ${w.est.payType==="salary"?'selected':''}>Salary</option>
                            </select>
                          </div>

                          <div>
                            <label>Estimated wages (preview)</label>
                            <input id="estWagePreview_${idx}" class="money preview-input ${calcPreview>0?'filled':''}" type="text" value="${fmtMoney(calcPreview)}" readonly>
                            <div class="help">Updates live as you type.</div>
                          </div>
                        </div>

                        ${w.est.payType==="hourly" ? `
                          <div class="grid3 mt12">
                            <div>
                              <label>Hourly rate</label>
                              <input type="number" min="0" step="0.01" data-bind="w2s.${idx}.est.hourly" value="${+w.est.hourly||0}">
                            </div>
                            <div>
                              <label>Hours per week</label>
                              <input type="number" min="0" step="0.1" data-bind="w2s.${idx}.est.hoursPerWeek" value="${+w.est.hoursPerWeek||0}">
                            </div>
                            <div>
                              <label>Weeks worked</label>
                              <input type="number" min="0" step="1" data-bind="w2s.${idx}.est.weeks" value="${+w.est.weeks||0}">
                            </div>
                          </div>
                        ` : `
                          <div class="mt12">
                            <label>Annual salary</label>
                            <input class="money" data-money="1" data-bind="w2s.${idx}.est.annualSalary" value="${(+w.est.annualSalary?Number(w.est.annualSalary).toLocaleString(): '')}">
                          </div>
                        `}

                        <div class="mt12">
                          <button class="btn primary calcWagesBtn" data-idx="${idx}" type="button">Calculate wages</button>
                          <div class="help mt8">Optional — it already updates live, but this confirms it.</div>
                        </div>
                      </div>
                    ` : ""}

                    <div class="section mt12">
                      <div class="section-title">Question 4</div>
                      <label>Do you know your federal withholding (W-2 Box 2) for this job?</label>
                      <div class="radio-group mt8">
                        <label class="radio-option">
                          <input type="radio" data-bind="w2s.${idx}.ui.knowsBox2" value="yes" ${knowsBox2==="yes"?'checked':''}>
                          <span><b>Yes</b> (I can enter Box 2)</span>
                        </label>
                        <label class="radio-option">
                          <input type="radio" data-bind="w2s.${idx}.ui.knowsBox2" value="no" ${knowsBox2==="no"?'checked':''}>
                          <span><b>No</b> (I don’t know Box 2)</span>
                        </label>
                      </div>
                    </div>

                    ${showBox2Field ? `
                      <div class="section mt12">
                        <div class="section-title">Enter withholding (from your W-2)</div>
                        <label>Federal withheld (W-2 Box 2)</label>
                        <input class="money" data-money="1" data-bind="w2s.${idx}.fedWh" value="${(+w.fedWh?Number(w.fedWh).toLocaleString(): '')}" inputmode="numeric" placeholder="Box 2">
                        <div class="help mt8">If you enter Box 2, we use it exactly.</div>
                      </div>
                    ` : ""}

                    ${showAskWantsEst ? `
                      <div class="section mt12">
                        <div class="section-title">Question 5</div>
                        <label>Do you want us to estimate your federal withholding?</label>
                        <div class="radio-group mt8">
                          <label class="radio-option">
                            <input type="radio" data-bind="w2s.${idx}.ui.wantsEstBox2" value="yes" ${wantsEst==="yes"?'checked':''}>
                            <span><b>Yes</b> (estimate it)</span>
                          </label>
                          <label class="radio-option">
                            <input type="radio" data-bind="w2s.${idx}.ui.wantsEstBox2" value="no" ${wantsEst==="no"?'checked':''}>
                            <span><b>No</b> (treat as $0)</span>
                          </label>
                        </div>
                        <div class="help mt8">If you choose “No”, this job’s withholding will be treated as $0 for the estimate.</div>
                      </div>
                    ` : ""}

                    ${showWhEstimatorUI ? `
                      <div class="section mt12">
                        <div class="section-title">Estimate Box 2 (rough)</div>
                        <div class="help">This auto-updates when you select pay frequency (and also stays live as you tweak inputs).</div>

                        <div class="grid2 mt12">
                          <div>
                            <label>Pay frequency</label>
                            <select data-bind="w2s.${idx}.whEst.payFreq">
                              <option value="weekly" ${w.whEst.payFreq==="weekly"?'selected':''}>Weekly</option>
                              <option value="biweekly" ${w.whEst.payFreq==="biweekly"?'selected':''}>Biweekly</option>
                              <option value="semimonthly" ${w.whEst.payFreq==="semimonthly"?'selected':''}>Semi-monthly</option>
                              <option value="monthly" ${w.whEst.payFreq==="monthly"?'selected':''}>Monthly</option>
                            </select>
                          </div>

                          <div>
                            <label>Estimated Box 2 (preview)</label>
                            <input id="box2Preview_${idx}" class="money preview-input ${whPreview>0?'filled':''}" type="text" value="${fmtMoney(whPreview)}" readonly>
                            <div class="help">Turns green when calculated.</div>
                          </div>
                        </div>

                        <div class="mt12">
                          <label>Do you claim dependents on your W-4?</label>
                          <div class="radio-group mt8">
                            <label class="radio-option">
                              <input type="radio" data-bind="w2s.${idx}.whEst.claimDeps" value="yes" ${w.whEst.claimDeps==="yes"?'checked':''}>
                              <span>Yes</span>
                            </label>
                            <label class="radio-option">
                              <input type="radio" data-bind="w2s.${idx}.whEst.claimDeps" value="no" ${w.whEst.claimDeps!=="yes"?'checked':''}>
                              <span>No</span>
                            </label>
                          </div>
                        </div>

                        ${w.whEst.claimDeps==="yes" ? `
                          <div class="mt12">
                            <label>How many dependents? (rough)</label>
                            <input type="number" min="0" data-bind="w2s.${idx}.whEst.depCount" value="${+w.whEst.depCount||0}">
                            <div class="help">If unsure, leave blank (we assume 1 if “Yes”).</div>
                          </div>
                        ` : ""}

                        <div class="mt12">
                          <label>Extra withholding per paycheck (optional)</label>
                          <input class="money" data-money="1" data-bind="w2s.${idx}.whEst.extraPerPay" value="${(+w.whEst.extraPerPay?Number(w.whEst.extraPerPay).toLocaleString(): '')}">
                        </div>

                        <div class="mt12">
                          <button class="btn primary estimateBox2Btn" data-idx="${idx}" type="button">Estimate Box 2</button>
                        </div>
                      </div>
                    ` : ""}

                    ${(knowsBox2==="no" && wantsEst==="no") ? `
                      <div class="info mt12">Withholding for this job will be treated as <b>$0</b> for the estimate.</div>
                    ` : ""}

                  </div>
                `;
              }).join("")}

              <div class="section mt12">
                <div class="section-title">Optional</div>
                <div class="help">If you have more jobs than you selected, you can add one.</div>
                <button id="addW2" class="btn secondary" type="button" style="width:100%">Add another W-2</button>
              </div>
            </div>
          ` : `
            <div class="info mt12">
              You selected <b>No</b>. This estimator is for W-2 only — we will continue with $0 wages.
            </div>
          `}

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "adjustments":
        return `
          <h3 class="title">Optional (Most people can skip)</h3>

          <div class="section">
            <div class="section-title">Do you want to enter adjustments?</div>
            <label>Examples: IRA deduction, student loan interest</label>
            <div class="radio-group mt8">
              <label class="radio-option">
                <input type="radio" data-bind="ui.enterAdjustments" value="true" ${state.ui.enterAdjustments===true?'checked':''}>
                <span><b>Yes</b> (I want to enter them)</span>
              </label>
              <label class="radio-option">
                <input type="radio" data-bind="ui.enterAdjustments" value="false" ${state.ui.enterAdjustments!==true?'checked':''}>
                <span><b>No</b> (skip)</span>
              </label>
            </div>
            <div class="help mt8">If you skip, we keep them at $0.</div>
          </div>

          ${state.ui.enterAdjustments===true ? `
            <div class="section mt12">
              <div class="grid2">
                <div>
                  <label>Traditional IRA deduction (optional)</label>
                  <input class="money" data-money="1" data-bind="adjustments.iraDeduction" value="${(+state.adjustments.iraDeduction?Number(state.adjustments.iraDeduction).toLocaleString(): '')}">
                  <div class="help">Max considered: ${fmtMoney(CONFIG_2025.adjustments.iraLimit)}.</div>
                </div>
                <div>
                  <label>Student loan interest (optional)</label>
                  <input class="money" data-money="1" data-bind="adjustments.studentLoanInterest" value="${(+state.adjustments.studentLoanInterest?Number(state.adjustments.studentLoanInterest).toLocaleString(): '')}">
                  <div class="help">Max considered: ${fmtMoney(CONFIG_2025.adjustments.studentLoanInterestCap)}.</div>
                </div>
              </div>
            </div>
          ` : `
            <div class="info mt12">Adjustments are skipped (set to $0).</div>
          `}

          <div class="section mt12">
            <div class="section-title">Quick questions (to show the next pages)</div>

            <label>Do you have children or dependents you claim?</label>
            <div class="radio-group mt8">
              <label class="radio-option">
                <input type="radio" data-bind="interview.hasDependents" value="yes" ${state.interview.hasDependents==="yes"?'checked':''}>
                <span>Yes</span>
              </label>
              <label class="radio-option">
                <input type="radio" data-bind="interview.hasDependents" value="no" ${state.interview.hasDependents==="no"?'checked':''}>
                <span>No</span>
              </label>
            </div>

            <div class="mt12">
              <label>Did you pay college tuition this year for yourself or a dependent?</label>
              <div class="radio-group mt8">
                <label class="radio-option">
                  <input type="radio" data-bind="interview.paidTuition" value="yes" ${state.interview.paidTuition==="yes"?'checked':''}>
                  <span>Yes</span>
                </label>
                <label class="radio-option">
                  <input type="radio" data-bind="interview.paidTuition" value="no" ${state.interview.paidTuition==="no"?'checked':''}>
                  <span>No</span>
                </label>
              </div>
            </div>

            <div class="help mt12">These answers only control which pages show next.</div>
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "kids":
        return `
          <h3 class="title">Kids & Child Tax Credit (CTC)</h3>

          <div class="info">
            This page shows because you said you have dependents.
          </div>

          <div class="section mt12">
            <label>Do the children you claim have SSNs?</label>
            <select data-bind="interview.kidsHaveSSN" class="mt8">
              <option value="" ${!state.interview.kidsHaveSSN?'selected':''}>Select…</option>
              <option value="yes" ${state.interview.kidsHaveSSN==="yes"?'selected':''}>Yes</option>
              <option value="no" ${state.interview.kidsHaveSSN==="no"?'selected':''}>No</option>
            </select>
            <div class="help mt8">If “No”, this estimator will treat CTC as $0.</div>
          </div>

          <div class="section mt12">
            <div class="grid2">
              <div>
                <label>How many lived with you more than half the year?</label>
                <input type="number" min="0" data-bind="interview.livedHalfCount" value="${+state.interview.livedHalfCount||0}">
              </div>
              <div>
                <label>How many were under 17 on Dec 31?</label>
                <input type="number" min="0" data-bind="interview.under17Count" value="${+state.interview.under17Count||0}">
              </div>
            </div>

            <div class="mt12">
              <label>Qualifying children for EITC</label>
              <input type="number" min="0" data-bind="interview.eitcChildren" value="${+state.interview.eitcChildren||0}">
              <div class="help mt8">If unsure, use the number who lived with you more than half the year.</div>
            </div>
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "eitc":
        return `
          <h3 class="title">Earned Income Credit (EITC)</h3>

          ${state.filingStatus==="mfs" ? `
            <div class="info">EITC is generally not allowed for Married Filing Separately. We will show $0 for EITC.</div>
          ` : `
            <div class="info">
              Answer two simple questions and we’ll check it for you.
            </div>
          `}

          <div class="section mt12">
            <label>About how much investment income did you have?</label>
            <div class="help mt8">Examples: interest, dividends, stock profits. If none, leave $0.</div>
            <input class="money mt8" data-money="1" data-bind="interview.investmentIncome" value="${(+state.interview.investmentIncome?Number(state.interview.investmentIncome).toLocaleString(): '')}">
          </div>

          ${state.interview.hasDependents!=="yes" ? `
            <div class="section mt12">
              <label>Qualifying children for EITC</label>
              <input type="number" min="0" data-bind="interview.eitcChildren" value="${+state.interview.eitcChildren||0}">
              <div class="help mt8">If none, leave 0. Some people can qualify with no kids (rules apply).</div>
            </div>
          ` : ""}

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "aotc":
        while(state.interview.students.length < 3) state.interview.students.push({tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false});
        return `
          <h3 class="title">College Tuition (AOTC)</h3>

          <div class="info">
            AOTC can be up to $2,500 per eligible student (with up to 40% refundable).
            <div class="help mt8">This is a rough check — exact eligibility requires full rules.</div>
          </div>

          ${state.filingStatus==="mfs" ? `
            <div class="info mt12">AOTC is not allowed for Married Filing Separately. This page will still show (because you said “Yes”), but AOTC will calculate to $0.</div>
          ` : ""}

          <div class="section mt12">
            <div class="grid2">
              <div>
                <label>Number of students</label>
                <select id="studentCountSel" data-bind="interview.studentCount" class="mt8">
                  ${[0,1,2,3].map(n=>`<option value="${n}" ${(+state.interview.studentCount===n)?'selected':''}>${n}</option>`).join("")}
                </select>
                <div class="help mt8">AOTC is limited to 4 total years per student.</div>
              </div>
              <div>
                <label>Reminder</label>
                <div class="info">Tuition should be net of scholarships/grants paid tax-free.</div>
              </div>
            </div>

            ${Array.from({length: clamp(+state.interview.studentCount||0,0,3)}).map((_,i)=>{
              const st = state.interview.students[i] || {tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false};
              return `
                <div class="w2-row mt12">
                  <div style="font-weight:950;color:#21484d">Student ${i+1}</div>

                  <div class="section mt12">
                    <label>Tuition paid (net)</label>
                    <input class="money mt8" data-money="1" data-bind="interview.students.${i}.tuitionNet" value="${st.tuitionNet?Number(st.tuitionNet).toLocaleString():''}">
                    <div class="help mt8">We consider up to $4,000 per student for max AOTC.</div>
                  </div>

                  <div class="grid2 mt12">
                    <div class="section">
                      <label>Years AOTC already claimed (0–3)</label>
                      <input class="mt8" type="number" min="0" max="3" data-bind="interview.students.${i}.yearsClaimed" value="${+st.yearsClaimed||0}">
                    </div>

                    <div class="section">
                      <label>At least half-time?</label>
                      <select class="mt8" data-bind="interview.students.${i}.halfTime">
                        <option value="true" ${(st.halfTime===true || st.halfTime==="true")?'selected':''}>Yes</option>
                        <option value="false" ${(st.halfTime===false || st.halfTime==="false")?'selected':''}>No</option>
                      </select>
                    </div>
                  </div>

                  <div class="section mt12">
                    <label>Felony drug conviction before end of the year?</label>
                    <select class="mt8" data-bind="interview.students.${i}.felony">
                      <option value="false" ${(st.felony===false || st.felony==="false")?'selected':''}>No</option>
                      <option value="true" ${(st.felony===true || st.felony==="true")?'selected':''}>Yes</option>
                    </select>
                    <div class="help mt8">If “Yes,” that student isn’t eligible for AOTC.</div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;

      case "results":
        const r = computeResults();
        const final = r.finalAmount;
        const finalLabel = final>=0 ? `${fmtMoney(final)} refund` : `${fmtMoney(-final)} owed`;
        setTimeout(()=> drawChart("chart", r), 0);

        return `
          <h3 class="title">Your Estimated Result</h3>
          <div class="chip">Year 2025</div>
          <div class="chip">${labelFS(state.filingStatus)}</div>

          <div class="section mt12" style="border:1px dashed #cfe8e4;background:#fbfffe">
            <div class="totals-grid" style="font-size:15px">
              <div><b>Estimated result</b></div><div class="kpi" style="font-size:18px">${finalLabel}</div>
            </div>
            <div class="help mt8">Federal estimate only. Not tax advice.</div>
          </div>

          <div class="info mt12">
            Bring your W-2(s) for an exact filing. This is an estimate based on what you entered.
          </div>

          <div class="grid2 mt12">
            <div class="section">
              <div class="section-title">Breakdown</div>
              <div class="totals-grid">
                <div>W-2 wages total</div><div class="kpi">${fmtMoney(r.wages)}</div>
                <div>Withholding total</div><div class="kpi">${fmtMoney(r.withholding)}</div>
                <div>AGI</div><div class="kpi">${fmtMoney(r.AGI)}</div>
                <div>Standard deduction</div><div class="kpi">${fmtMoney(r.stdDed)}</div>
                <div>Taxable income</div><div class="kpi">${fmtMoney(r.taxable)}</div>
                <div>Tax before credits</div><div class="kpi">${fmtMoney(r.taxBefore)}</div>

                <div>CTC (nonref / refundable)</div><div class="kpi">${fmtMoney(r.ctc.nonrefundable)} / ${fmtMoney(r.ctc.refundable)}</div>
                <div>AOTC (nonref / refundable)</div><div class="kpi">${fmtMoney(r.aotc.nonrefundable)} / ${fmtMoney(r.aotc.refundable)}</div>
                <div>EITC</div><div class="kpi">${fmtMoney(r.eitc)}</div>

                <div>Tax after nonref credits</div><div class="kpi">${fmtMoney(r.taxAfterNonref)}</div>
                <div>Refundable credits total</div><div class="kpi">${fmtMoney(r.refundableTotal)}</div>
                <div>Total payments</div><div class="kpi">${fmtMoney(r.totalPayments)}</div>
              </div>

              <div class="mt12">
                <button class="btn link" type="button" data-action="reset">Start Over</button>
              </div>
            </div>

            <div class="section">
              <div class="section-title">Visual</div>
              <canvas id="chart" width="540" height="320" aria-label="Summary chart"></canvas>
            </div>
          </div>

          <div id="errorArea" class="mt12" tabindex="-1" aria-live="polite"></div>
        `;
    }
  }

  function drawChart(id, results){
    const c = document.getElementById(id);
    if(!c) return;
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    const data = [
      {label:"Tax", val: results.taxBefore},
      {label:"Nonref Credits", val: results.taxBefore - results.taxAfterNonref},
      {label:"Refundable Credits", val: results.refundableTotal},
      {label:"Withholding", val: results.withholding},
      {label:"Final", val: Math.abs(results.finalAmount)},
    ];
    const max = Math.max(...data.map(d=>d.val)) || 1;
    const pad = 30, w=80, gap=28;
    const baseY = c.height - 40;

    data.forEach((d,i)=>{
      const h = Math.round((d.val / max) * (c.height - 100));
      const x = pad + i*(w+gap);
      const y = baseY - h;

      const colors = ["#0f8f82","#87e0d6","#b6f0ea","#3fb4a8", results.finalAmount>=0 ? "#21a57f" : "#c55353"];
      ctx.fillStyle = colors[i];
      ctx.fillRect(x, y, w, h);

      ctx.fillStyle = "#123";
      ctx.font = "12px system-ui";
      ctx.textAlign = "center";
      ctx.fillText(d.label, x+w/2, baseY+16);
      ctx.fillText(fmtMoney(d.val), x+w/2, Math.max(14,y-6));
    });
  }

  function wireFooterOnce(){
    const back = document.getElementById("backBtn");
    const next = document.getElementById("nextBtn");
    const reset = document.getElementById("startOverBtn");
    const topBack = document.getElementById("topBackBtn");

    if(back && !back.dataset.wired){
      back.dataset.wired="1";
      back.addEventListener("click", (e)=>{ e.preventDefault(); goBack(); }, true);
    }
    if(topBack && !topBack.dataset.wired){
      topBack.dataset.wired="1";
      topBack.addEventListener("click", (e)=>{ e.preventDefault(); goBack(); }, true);
    }
    if(next && !next.dataset.wired){
      next.dataset.wired="1";
      next.addEventListener("click", (e)=>{ e.preventDefault(); goNext(); }, true);
    }
    if(reset && !reset.dataset.wired){
      reset.dataset.wired="1";
      reset.addEventListener("click", (e)=>{ e.preventDefault(); resetState(); }, true);
    }
  }

  (function init(){
    if(state.interview.paidTuition===null) state.interview.paidTuition="no";
    if(state.interview.hasDependents===null) state.interview.hasDependents="no";
    if(state.work.hasW2Job===null) state.work.hasW2Job="yes";

    ensureW2Count(state.work.jobCount || 1);
    normalizeInterviewFlags();

    rebuildStepPlan();
    wireFooterOnce();
    render();
    saveState();
  })();
  </script>

</body>
</html>
