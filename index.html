<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CARE & TAX SERVICES – Refund Estimator (2025)</title>
  <style>
    :root{
      --mint:#2bb7a8;
      --mint-200:#c8f1ec;
      --mint-100:#e9fbf8;
      --text:#233236;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(0,0,0,.08);
      --radius:14px;
      --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
      background:linear-gradient(180deg,var(--mint-100),#e8faf7);
      color:var(--text);
      line-height:1.35;
    }
    header{ padding:24px 16px 8px; text-align:center; }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    h2{margin:6px 0 12px;font-size:18px;font-weight:600;color:#2a4a4f}
    .progress-wrap{max-width:980px;margin:0 auto 8px auto;padding:0 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .progress-label{font-size:13px;color:#2a4a4f;min-width:120px;text-align:right}
    .progress{
      position:relative;flex:1;height:8px;border-radius:999px;background:#d9f4f0;overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
    }
    .progress>div{height:100%;background:var(--mint);width:0%;transition:width .35s ease}

    .wrap{max-width:1200px;margin:0 auto;padding:8px 16px 120px 16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .title{margin:0 0 8px;font-size:20px}
    .muted{color:#5a6d72;font-size:14px}
    .info{background:#f7fbfc;border:1px dashed #b8dadd;border-radius:12px;padding:12px;color:#34565d}
    .banner{
      background:#e9faf7;border:1px solid #bfece6;border-radius:12px;padding:10px 12px;
      display:flex;gap:10px;align-items:flex-start;color:#0f4f49
    }
    .banner strong{white-space:nowrap}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    label{font-size:14px;font-weight:600}
    input[type="text"],input[type="number"],select{
      width:100%;padding:10px 12px;border:1px solid #cfd9dc;border-radius:10px;font-size:15px;outline:0;
      background:#fff;transition:box-shadow .15s,border-color .15s;
    }
    input:focus,select:focus{box-shadow:0 0 0 3px #a8efe7;border-color:#2bb7a8}
    .help{font-size:12px;color:#6c8187}
    .error{font-size:13px;color:#a72a2a;margin-top:2px}
    .money{ text-align:right }
    .inline{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .radio-group{display:grid;grid-template-columns:1fr;gap:8px}
    .radio-option{display:flex;gap:10px;align-items:center;padding:8px 10px;border:1px solid #d9e6e8;border-radius:10px;cursor:pointer}
    .radio-option input{margin:0}
    .w2-row{border:1px solid #e6eff1;border-radius:12px;padding:12px}
    .btn{
      appearance:none;border:0;border-radius:999px;padding:12px 18px;font-weight:800;cursor:pointer;
      transition:transform .02s ease, background .15s, color .15s, box-shadow .15s;outline:0
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--mint);color:#fff;box-shadow:0 6px 16px rgba(43,183,168,.25)}
    .btn.primary:hover{background:#23a99b}
    .btn.secondary{background:#f0f8f7;color:#13524b;border:2px solid #bfece6}
    .btn.link{background:transparent;color:#17655c;text-decoration:underline;padding:6px 0;border-radius:6px}
    .btn.small{padding:8px 12px;font-size:13px}
    .footer-nav{
      position:fixed;left:0;right:0;bottom:0;background:#fbfffe;border-top:1px solid #d9ece9;
      display:flex;gap:10px;justify-content:space-between;padding:12px 16px;z-index:20;
    }
    .footer-nav .left,.footer-nav .right{display:flex;gap:10px}

    .grid-desktop{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1024px){
      .wrap{grid-template-columns:minmax(0,760px) 1fr}
      .grid-desktop{grid-template-columns:1fr}
      .sidebar{position:sticky;top:12px;align-self:start}
      .footer-nav{position:static;background:transparent;border:0;padding:0}
    }

    .totals-head{display:flex;justify-content:space-between;align-items:center}
    .toggle{background:#e9faf7;border:1px solid #bfece6;color:#0e4b45;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
    .totals-body{margin-top:10px}
    .totals-grid{display:grid;grid-template-columns:1fr auto;gap:8px;font-size:14px}
    .kpi{font-weight:800}

    .drawer{display:block}
    @media(max-width:1023px){
      .drawer.collapsed .totals-body{display:none}
    }

    @media print{
      body{background:#fff}
      .footer-nav, .sidebar, .progress-wrap, .acceptance, .controls, .btn.link{display:none !important}
      .print-scope-summary .print-section-summary{display:block}
      .print-scope-summary .print-section-checklist{display:none}
      .print-scope-checklist .print-section-summary{display:none}
      .print-scope-checklist .print-section-checklist{display:block}
      .card{box-shadow:none;border:1px solid #ccc}
    }
    .print-section-summary, .print-section-checklist{display:block}
    .chip{display:inline-block;background:#e7faf7;border:1px solid #bfece6;border-radius:999px;padding:4px 10px;font-size:12px;color:#0d4f48;margin-right:6px}
    .tip{display:inline-block;border-radius:999px;background:#e8f8f6;border:1px solid #bfece6;width:18px;height:18px;line-height:18px;text-align:center;font-weight:900;color:#14665d;margin-left:6px}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mb0{margin-bottom:0}
    .space-between{display:flex;justify-content:space-between;align-items:center}
    .acceptance{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    canvas{max-width:100%;background:#fff;border-radius:12px;border:1px solid #e5eeee}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:720px){
      .grid2,.grid3{grid-template-columns:1fr}
    }
    .section{border:1px solid #e6eff1;border-radius:12px;padding:12px}
    .section-title{margin:0 0 8px;font-size:15px;color:#21484d}

    .subcard{
      background:#fff;
      border:1px solid #e6eff1;
      border-radius:14px;
      padding:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
    }
    .stack{display:flex;flex-direction:column;gap:14px}
    .subcard .section-title{margin:0 0 10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #cfe8e4;background:#f6fffd;border-radius:999px;padding:6px 10px;font-size:13px;color:#0f4f49}
    .hr{height:1px;background:#e7f2f1;margin:12px 0}
  </style>
</head>
<body>
  <header>
    <h1>CARE & TAX SERVICES – Stone Mtn</h1>
    <h2>Federal Refund Estimator (2025)</h2>
    <div class="muted">Georgia clients • Federal estimate only (no state taxes)</div>
  </header>

  <div class="progress-wrap" aria-live="polite">
    <div class="progress-label"><span id="stepText">Step 1 of 1</span></div>
    <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
  </div>

  <main class="wrap" id="app" aria-live="polite">
    <section id="mainCol" class="grid-desktop"></section>
    <aside id="sidebar" class="sidebar">
      <div class="card drawer collapsed" id="totalsDrawer" aria-label="Running Totals">
        <div class="totals-head">
          <strong>Running Totals</strong>
          <button class="toggle" id="toggleTotals" aria-expanded="false" type="button">Show</button>
        </div>
        <div class="totals-body" id="totalsBody">
          <div class="totals-grid">
            <div>W-2 Wages (est.)</div><div class="kpi" id="rtWages">$0</div>
            <div>Withholding (est.)</div><div class="kpi" id="rtWh">$0</div>
            <div>AGI (preview)</div><div class="kpi" id="rtAGI">$0</div>
            <div>Std Deduction</div><div class="kpi" id="rtStdDed">$0</div>
          </div>
          <div class="help mt8" id="rtNote"></div>
        </div>
      </div>
    </aside>
  </main>

  <div class="footer-nav" id="footerNav">
    <div class="left">
      <button class="btn secondary" id="backBtn" type="button">Back</button>
    </div>
    <div class="right">
      <button class="btn secondary" id="startOverBtn" type="button">Start Over</button>
      <button class="btn primary" id="nextBtn" type="button">Next</button>
    </div>
  </div>

  <script>
  /* =========================================================
     2025 ONLY — IRS-BASED CONFIG (keep numbers exact)
     ========================================================= */
  const CONFIG_2025 = {
    year: 2025,

    // Standard deduction (TY 2025)
    stdDeduction: { single:15750, mfj:31500, mfs:15750, hoh:23625, qw:31500 },

    // Additional standard deduction (age 65+) — per-person add-on
    ageAddOn: { single:2000, hoh:2000, mfj:1600, mfs:1600, qw:1600 },

    // 2025 brackets (top of each bracket, then Infinity)
    brackets: {
      single: [[11925,.10],[48475,.12],[103350,.22],[197300,.24],[250525,.32],[626350,.35],[Infinity,.37]],
      mfj:    [[23850,.10],[96950,.12],[206700,.22],[394600,.24],[501050,.32],[751600,.35],[Infinity,.37]],
      mfs:    [[11925,.10],[48475,.12],[103350,.22],[197300,.24],[250525,.32],[375800,.35],[Infinity,.37]],
      hoh:    [[17000,.10],[64850,.12],[103350,.22],[197300,.24],[250500,.32],[626350,.35],[Infinity,.37]],
      qw:     [[23850,.10],[96950,.12],[206700,.22],[394600,.24],[501050,.32],[751600,.35],[Infinity,.37]],
    },

    // Child Tax Credit (2025)
    ctc: {
      perChild: 2200,
      refundableCapPerChild: 1700,
      phaseoutThreshold: { single:200000, hoh:200000, qw:200000, mfj:400000, mfs:200000 }, // MFS uses $200k unless you enforce a different verified threshold
      phaseoutPer1000: 50,
      earnedIncomeThreshold: 2500
    },

    // AOTC (keep as standard Form 8863 rule set)
    aotc: {
      phaseout: { single:[80000,90000], hoh:[80000,90000], qw:[80000,90000], mfj:[160000,180000], mfs:[0,0] },
      refundableRate: 0.40,
      refundableCapPerStudent: 1000,
      perStudentMax: 2500
    },

    // EITC (2025 values + standard worksheet % params)
    eitc: {
      investmentIncomeLimit: 11950,
      params: {
        0: { phaseIn:.0765, earnedMax:8490,  max:649,  phaseOutRate:.0765, start:{single:10620, hoh:10620, qw:10620, mfj:17570, mfs:0} },
        1: { phaseIn:.34,   earnedMax:12770, max:4328, phaseOutRate:.1598, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
        2: { phaseIn:.40,   earnedMax:17880, max:7152, phaseOutRate:.2106, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
        3: { phaseIn:.45,   earnedMax:17880, max:8046, phaseOutRate:.2106, start:{single:23350, hoh:23350, qw:23350, mfj:30300, mfs:0} },
      }
    },

    // Optional adjustments (kept, but you can remove if you truly want W-2 only)
    adjustments: { iraLimit: 7000, studentLoanInterestCap: 2500 }
  };

  /* ===========================
     STATE & PERSISTENCE
     =========================== */
  const LS_KEY = "caretax_refund_estimator_2025_v1";

  function defaultW2(){
    return {
      employer:"",
      // exact mode
      wages:0,
      fedWh:0,

      // estimate toggles
      estimatingW2: false,
      estimatingWh: true, // if Box 2 missing, estimate by default

      // estimate inputs
      payType: "hourly",          // hourly | salary
      hourlyRate: 20,
      hoursPerWeek: 40,
      salaryAmount: 40000,
      payFrequency: "biweekly",   // weekly | biweekly | semimonthly | monthly
      monthsWorked: 12,
      federalWithholdingUsuallyTaken: "yes" // yes | no | unsure
    };
  }

  const defaultState = () => ({
    year: 2025,

    filingStatus: null, // "single" | "mfj" | "mfs" | "hoh" | "qw"
    ages: { taxpayer: null, spouse: null },

    w2s: [ defaultW2() ],

    adjustments: { iraDeduction:0, studentLoanInterest:0 },

    // quick interview
    interview: {
      hasDependents: "no",
      livedHalfCount: 0,
      under17Count: 0,

      // SSN screening for CTC (simple)
      kidsHaveSSN: "yes", // yes | no | unsure

      // EITC
      eitcQualKids: 0,
      investmentIncome: 0,

      // AOTC
      paidTuition: "no",
      studentCount: 0,
      students: [{ tuitionNet:0, yearsClaimed:0, halfTime:true, felony:false }]
    },

    // internal normalized
    dependents: { total:0, under17:0, eitcChildren:0 },
    creditsSelected: { ctc:false, aotc:false, eitc:false },
    aotc: { studentCount:0, students:[] },
    eitc: { investmentIncome:0 },

    stepPlan: ["welcome","status","income","interview","results"],
    currentStepIndex: 0
  });

  let state = loadState();

  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY));
      if(!s || typeof s !== 'object') return defaultState();
      return deepMerge(defaultState(), s);
    }catch(e){ return defaultState(); }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function resetState(){
    localStorage.removeItem(LS_KEY);
    state = defaultState();
    saveState();
    render();
  }
  function deepMerge(base, incoming){
    if(typeof base !== 'object' || base === null) return incoming;
    const out = Array.isArray(base) ? [...base] : {...base};
    for(const k in base){
      if(incoming && Object.prototype.hasOwnProperty.call(incoming,k)){
        if(typeof base[k] === 'object' && base[k] !== null){
          out[k] = deepMerge(base[k], incoming[k]);
        }else out[k] = incoming[k];
      }
    }
    for(const k in incoming){ if(!(k in out)) out[k] = incoming[k]; }
    return out;
  }

  /* ===========================
     HELPERS
     =========================== */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  function fmtMoney(n){ if(n===null||n===undefined) return "$0"; return Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
  function parseMoney(str){ if(str===null||str===undefined) return 0; const num = +String(str).replace(/[^\d.-]/g,""); return isFinite(num)?num:0; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function labelFS(code){
    return {single:"Single", mfj:"Married Filing Jointly", mfs:"Married Filing Separately", hoh:"Head of Household", qw:"Qualifying Surviving Spouse"}[code] || "—";
  }

  // annualized wage estimate for a single W-2 card (if estimatingW2 enabled)
  function estimateW2Wages(w){
    const months = clamp(+w.monthsWorked||0, 0, 12);
    if(months <= 0) return 0;

    if(w.payType === "salary"){
      const annual = Math.max(0, +w.salaryAmount||0);
      return Math.round(annual * (months/12));
    }

    // hourly
    const rate = Math.max(0, +w.hourlyRate||0);
    const hrs = clamp(+w.hoursPerWeek||0, 0, 80);
    const weekly = rate * hrs;
    // annualize by months worked (approx)
    const annual = weekly * 52 * (months/12);
    return Math.round(annual);
  }

  function effectiveWages(w){
    const exact = Math.max(0, +w.wages||0);
    if(!w.estimatingW2) return Math.round(exact);
    const est = estimateW2Wages(w);
    // if they typed wages anyway, prefer wages (some users will)
    return Math.round(exact>0 ? exact : est);
  }

  function sumWages(w2s){ return Math.round(w2s.reduce((a,w)=>a + effectiveWages(w),0)); }
  function sumEnteredWithholding(w2s){ return Math.round(w2s.reduce((a,w)=>a + Math.max(0,+w.fedWh||0),0)); }

  function calcAGI(_state){
    const wages = sumWages(_state.w2s);
    const ira = clamp(+_state.adjustments.iraDeduction||0, 0, CONFIG_2025.adjustments.iraLimit);
    const sli = clamp(+_state.adjustments.studentLoanInterest||0, 0, CONFIG_2025.adjustments.studentLoanInterestCap);
    return Math.round(Math.max(0, wages - ira - sli));
  }

  function calcStandardDeduction(_state){
    const status = _state.filingStatus || "single";
    const base = CONFIG_2025.stdDeduction[status] || 0;
    const addCfg = CONFIG_2025.ageAddOn;

    const t65 = +(_state.ages.taxpayer||0) >= 65;
    const s65 = status==="mfj" ? +(_state.ages.spouse||0) >= 65 : false;

    const addPer = addCfg[status] || addCfg.single || 0;
    const add = (t65?addPer:0) + (s65?addPer:0);

    return base + add;
  }

  function calcTax(taxableIncome, filingStatus){
    let tax = 0;
    let prev = 0;
    const brackets = CONFIG_2025.brackets[filingStatus] || CONFIG_2025.brackets.single;
    const income = Math.max(0, taxableIncome);
    for(const [limit, rate] of brackets){
      const amount = Math.min(income, limit - prev);
      if(amount > 0) tax += amount * rate;
      prev = limit;
      if(income <= limit) break;
    }
    return Math.round(tax);
  }

  function calcCTC({MAGI, filingStatus, eligibleUnder17, earnedIncome, taxBeforeCredits, kidsHaveSSN}){
    const cfg = CONFIG_2025.ctc;

    // simple SSN gate: if "no" then we assume not eligible in this rough tool
    if(kidsHaveSSN === "no") return { nonrefundable:0, refundable:0, note:"No SSN selected → CTC set to $0 in estimator." };

    const baseCredit = (eligibleUnder17||0) * cfg.perChild;
    const threshold = cfg.phaseoutThreshold[filingStatus] || cfg.phaseoutThreshold.single;

    const phaseout = Math.max(0, Math.ceil(Math.max(0, MAGI - threshold)/1000) * cfg.phaseoutPer1000);
    const afterPhase = Math.max(0, baseCredit - phaseout);

    const nonref = Math.min(afterPhase, taxBeforeCredits);

    const remaining = Math.max(0, afterPhase - nonref);
    const earnedExcess = Math.max(0,(earnedIncome||0) - cfg.earnedIncomeThreshold);
    const actcMaxByIncome = Math.round(earnedExcess * 0.15);
    const actcCap = (eligibleUnder17||0) * cfg.refundableCapPerChild;
    const refundable = Math.min(remaining, actcCap, actcMaxByIncome);

    return { nonrefundable: Math.round(nonref), refundable: Math.round(refundable), note:"" };
  }

  function calcAOTC(students, MAGI, filingStatus){
    const cfg = CONFIG_2025.aotc;
    const disallowedReasons = [];

    if(filingStatus==="mfs"){
      disallowedReasons.push("AOTC not allowed for Married Filing Separately.");
      return { nonrefundable:0, refundable:0, disallowedReasons };
    }

    let base=0, refundableBase=0, count=0;

    students.forEach((s,i)=>{
      if(!s) return;
      const years = +s.yearsClaimed||0;
      const tuition = Math.max(0, +s.tuitionNet||0);
      const half = !!s.halfTime;
      const fel = !!s.felony;

      if(tuition<=0){ disallowedReasons.push(`Student ${i+1}: tuition must be > 0`); return; }
      if(years>=4){ disallowedReasons.push(`Student ${i+1}: exceeds 4-year limit`); return; }
      if(!half){ disallowedReasons.push(`Student ${i+1}: must be at least half-time`); return; }
      if(fel){ disallowedReasons.push(`Student ${i+1}: felony drug conviction rule`); return; }

      const first2k = Math.min(2000, tuition);
      const next2k  = Math.min(2000, Math.max(0, tuition - 2000));
      const credit  = first2k + 0.25 * next2k; // max 2500 if tuition >= 4000

      base += credit;
      refundableBase += Math.min(cfg.refundableCapPerStudent, credit * cfg.refundableRate);
      count++;
    });

    if(count===0) return { nonrefundable:0, refundable:0, disallowedReasons };

    const [lo,hi] = cfg.phaseout[filingStatus] || [0,0];
    let factor = 1;
    if(hi>lo && MAGI>lo){
      if(MAGI>=hi) factor = 0;
      else factor = (hi - MAGI)/(hi - lo);
    }

    base *= factor;
    refundableBase *= factor;

    const nonref = Math.max(0, base - refundableBase);
    const refundable = Math.max(0, refundableBase);

    return { nonrefundable: Math.round(nonref), refundable: Math.round(refundable), disallowedReasons };
  }

  function calcEITC(earnedIncome, AGI, filingStatus, qualChildren, investmentIncome){
    const invLimit = CONFIG_2025.eitc.investmentIncomeLimit;
    if((investmentIncome||0) > invLimit) return 0;
    if(filingStatus==="mfs") return 0;

    const n = Math.max(0, Math.min(3, +qualChildren||0));
    const p = CONFIG_2025.eitc.params[n];
    if(!p) return 0;

    const income = Math.min(earnedIncome||0, AGI||0);

    const phaseInAmt = Math.min(income, p.earnedMax);
    const phaseInCredit = phaseInAmt * p.phaseIn;
    const maxCredit = Math.min(p.max, phaseInCredit);

    const start = (p.start[filingStatus] ?? p.start.single);
    const poi = Math.max(0, (income - start) * p.phaseOutRate);

    return Math.round(Math.max(0, maxCredit - poi));
  }

  function orderCredits({taxBefore}, nonrefList, refundableList){
    const nonrefTotal = Math.min(taxBefore, nonrefList.reduce((a,b)=>a+(b||0),0));
    const taxAfterNonref = Math.max(0, taxBefore - nonrefTotal);
    const refundableTotal = refundableList.reduce((a,b)=>a+(b||0),0);
    return { taxAfterNonref, refundableTotal };
  }

  function buildFormsChecklist(_state, results){
    const forms = ["Form 1040"];
    if((_state.adjustments.iraDeduction||0)>0 || (_state.adjustments.studentLoanInterest||0)>0) forms.push("Schedule 1");
    if((_state.creditsSelected.ctc) && (results.ctc.nonrefundable>0 || results.ctc.refundable>0)) forms.push("Schedule 8812 (incl. Worksheets)");
    if((_state.creditsSelected.aotc) && (results.aotc.nonrefundable>0 || results.aotc.refundable>0)) {
      forms.push("Form 8863");
      if(results.aotc.nonrefundable>0) forms.push("Schedule 3");
    }
    if((_state.creditsSelected.eitc) && results.eitc>0){
      forms.push((_state.dependents.eitcChildren>0 ? "Schedule EIC" : "EITC Worksheet"));
    }
    return forms;
  }

  /* ===========================
     GUIDED INTERVIEW → AUTO-SELECT
     =========================== */
  function normalizeInterviewToState(){
    const s = state;

    const hasDeps = s.interview.hasDependents === "yes";
    const livedHalf = hasDeps ? clamp(+s.interview.livedHalfCount||0, 0, 99) : 0;
    const under17 = hasDeps ? clamp(+s.interview.under17Count||0, 0, livedHalf) : 0;

    s.dependents.total = livedHalf;
    s.dependents.under17 = under17;

    const eitcKids = clamp(+s.interview.eitcQualKids||0, 0, 99);
    s.dependents.eitcChildren = eitcKids;

    const inv = clamp(+s.interview.investmentIncome||0, 0, 9e15);
    s.eitc.investmentIncome = inv;

    // auto-select credits (simple)
    s.creditsSelected.ctc = (under17 > 0);
    s.creditsSelected.eitc = (s.filingStatus !== "mfs"); // still can be 0 by calc rules
    s.creditsSelected.aotc = (s.interview.paidTuition === "yes");

    // AOTC students
    const sc = (s.interview.paidTuition==="yes") ? clamp(+s.interview.studentCount||0, 0, 3) : 0;
    s.aotc.studentCount = sc;

    while(s.interview.students.length < sc) s.interview.students.push({tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false});
    if(s.interview.students.length > sc) s.interview.students = s.interview.students.slice(0, sc);

    s.aotc.students = (s.interview.students||[]).slice(0, sc).map(st=>({
      tuitionNet: Math.max(0, +st.tuitionNet||0),
      yearsClaimed: clamp(+st.yearsClaimed||0, 0, 3),
      halfTime: (st.halfTime===true || st.halfTime==="true"),
      felony: (st.felony===true || st.felony==="true")
    }));

    saveState();
  }

  /* ===========================
     WITHHOLDING ESTIMATION (ROUGH)
     =========================== */
  function computeEstimatedWithholding(totalTaxBefore, w2s){
    // If user entered Box 2, use it. If not, estimate.
    // Heuristic:
    // - If federalWithholdingUsuallyTaken === "no" -> 0
    // - If "yes"/"unsure" and estimatingWh=true -> allocate estimated taxBefore across missing W-2s
    const entered = w2s.reduce((a,w)=>a + Math.max(0,+w.fedWh||0),0);

    const missing = w2s
      .map((w,idx)=>({w,idx}))
      .filter(x => (Math.max(0,+x.w.fedWh||0) === 0) && (x.w.estimatingWh === true));

    if(missing.length === 0) return { total: Math.round(entered), estimatedPart: 0, usedEstimate:false };

    // decide which missing W-2s should have withholding
    const eligibleMissing = missing.filter(x=>{
      const flag = (x.w.federalWithholdingUsuallyTaken||"yes");
      return flag !== "no";
    });

    if(eligibleMissing.length === 0){
      return { total: Math.round(entered), estimatedPart: 0, usedEstimate: false };
    }

    // estimate remaining withholding as (totalTaxBefore - entered) but never below 0
    // (this keeps things consistent: if you didn't enter box 2, we assume it was enough to cover tax before credits)
    const remaining = Math.max(0, Math.round(totalTaxBefore - entered));

    // allocate proportionally by wages for those missing
    const sumMissingWages = eligibleMissing.reduce((a,x)=>a + effectiveWages(x.w),0) || 1;
    let estParts = new Array(w2s.length).fill(0);
    eligibleMissing.forEach(x=>{
      const share = effectiveWages(x.w) / sumMissingWages;
      estParts[x.idx] = Math.round(remaining * share);
    });

    const estimatedPart = estParts.reduce((a,b)=>a+b,0);
    const total = Math.round(entered + estimatedPart);

    return { total, estimatedPart, usedEstimate:true };
  }

  /* ===========================
     VALIDATION
     =========================== */
  function validate(step){
    const errors = [];
    const s = state;

    switch(step){
      case "welcome":
        // nothing
        break;

      case "status":
        if(!s.filingStatus) errors.push("Choose a filing status.");
        if(s.ages.taxpayer===null || isNaN(+s.ages.taxpayer) || +s.ages.taxpayer<0 || +s.ages.taxpayer>120) errors.push("Enter a valid taxpayer age.");
        if(s.filingStatus==="mfj"){
          if(s.ages.spouse===null || isNaN(+s.ages.spouse) || +s.ages.spouse<0 || +s.ages.spouse>120) errors.push("Enter a valid spouse age.");
        }
        break;

      case "income":
        if(!s.w2s.length) errors.push("Add at least one W-2.");
        s.w2s.forEach((w,i)=>{
          if(w.estimatingW2){
            // allow blank exact wages, but require enough estimate inputs to compute >0 OR allow 0
            const est = estimateW2Wages(w);
            const exact = Math.max(0,+w.wages||0);
            if(est<=0 && exact<=0) errors.push(`W-2 #${i+1}: enter wages OR use the estimate inputs to estimate wages.`);
          } else {
            if(isNaN(+w.wages) || +w.wages<0) errors.push(`W-2 #${i+1}: wages must be ≥ 0`);
          }
          if(isNaN(+w.fedWh) || +w.fedWh<0) errors.push(`W-2 #${i+1}: withholding must be ≥ 0`);
        });
        if(+s.adjustments.iraDeduction<0) errors.push("IRA deduction cannot be negative.");
        if(+s.adjustments.studentLoanInterest<0) errors.push("Student loan interest cannot be negative.");
        break;

      case "interview":
        if(!["yes","no"].includes(s.interview.hasDependents)) errors.push("Please answer the dependents question.");
        if(+s.interview.livedHalfCount<0) errors.push("Dependents count can’t be negative.");
        if(+s.interview.under17Count<0) errors.push("Under-17 count can’t be negative.");
        if(+s.interview.under17Count > +s.interview.livedHalfCount) errors.push("Under-17 count can’t be more than the dependents who lived with you > half the year.");
        if(+s.interview.investmentIncome<0) errors.push("Investment income can’t be negative.");
        if(!["yes","no"].includes(s.interview.paidTuition)) errors.push("Please answer the college tuition question.");
        if(s.interview.paidTuition==="yes"){
          const sc = clamp(+s.interview.studentCount||0, 0, 3);
          if(sc<=0) errors.push("If you paid tuition, select the number of students (1–3).");
        }
        break;
    }
    return errors;
  }

  /* ===========================
     STEP NAV
     =========================== */
  function currentStep(){ return state.stepPlan[state.currentStepIndex] || "welcome"; }

  function goNext(){
    const step = currentStep();
    const errs = validate(step);
    if(errs.length){ showErrors(errs); return; }
    if(step==="interview"){ normalizeInterviewToState(); }
    if(state.currentStepIndex < state.stepPlan.length-1){
      state.currentStepIndex++;
      saveState();
      render();
    }
  }
  function goBack(){
    if(state.currentStepIndex>0){
      state.currentStepIndex--;
      saveState();
      render();
    }
  }

  /* ===========================
     UI
     =========================== */
  const mainCol = document.getElementById('mainCol');
  const stepText = document.getElementById('stepText');
  const progressBar = document.getElementById('progressBar');

  function showErrors(list){
    const area = $("#errorArea");
    if(area){
      area.innerHTML = list.map(e=>`<div class="error">• ${e}</div>`).join("");
      area.focus();
      area.scrollIntoView({behavior:"smooth", block:"start"});
    } else {
      alert(list.join("\n"));
    }
  }

  function setByPath(obj, path, value){
    const parts = Array.isArray(path)?path: String(path).split(".");
    let ref = obj;
    for(let i=0;i<parts.length-1;i++){
      const k = parts[i];
      if(!(k in ref)) ref[k] = {};
      ref = ref[k];
    }
    ref[parts[parts.length-1]] = value;
  }

  function render(){
    const total = state.stepPlan.length;
    const idx = state.currentStepIndex + 1;
    stepText.textContent = `Step ${idx} of ${total}`;
    progressBar.style.width = `${(idx-0.01)/total*100}%`;

    const step = currentStep();
    $('#backBtn').disabled = state.currentStepIndex===0;
    $('#nextBtn').style.display = step==="results" ? "none" : "inline-block";
    $('#backBtn').style.visibility = step==="results" ? "hidden" : "visible";

    mainCol.innerHTML = "";
    const card = document.createElement('div');
    card.className = "card";
    card.innerHTML = renderStep(step);
    mainCol.appendChild(card);

    attachCommonHandlers(card);
    updateTotals();

    card.onkeydown = (e)=>{
      if(e.key==="Enter"){
        if(e.target && (e.target.tagName==="BUTTON" || e.target.type==="button")) return;
        e.preventDefault();
        const errs = validate(step);
        if(errs.length){ showErrors(errs); return; }
        goNext();
      }
    }

    window.scrollTo({top:0,behavior:'smooth'});
  }

  function attachCommonHandlers(scope){
    $$('input[data-money]', scope).forEach(el=>{
      el.addEventListener('focus', ()=>{ el.value = parseMoney(el.value); });
      el.addEventListener('blur', ()=>{
        const num = parseMoney(el.value);
        el.value = num ? num.toLocaleString() : "";
      });
      el.addEventListener('input', ()=>{
        const num = parseMoney(el.value);
        setByPath(state, el.dataset.bind, isFinite(num)?num:0);
        saveState();
        updateTotals();
      });
    });

    $$('input[type="number"]:not([data-money])', scope).forEach(el=>{
      el.addEventListener('input', ()=>{
        let v = +el.value;
        if(v<0) v=0;
        setByPath(state, el.dataset.bind, isFinite(v)?v:0);
        saveState(); updateTotals();
      });
    });

    $$('input[type="text"]:not([data-money])', scope).forEach(el=>{
      el.addEventListener('input', ()=>{
        setByPath(state, el.dataset.bind, el.value);
        saveState();
      });
    });

    $$('select, input[type="radio"], input[type="checkbox"]', scope).forEach(el=>{
      el.addEventListener('change', ()=>{
        if(el.type==="checkbox") setByPath(state, el.dataset.bind, el.checked);
        else if (el.type === "radio") setByPath(state, el.dataset.bind || el.name, el.value);
        else setByPath(state, el.dataset.bind, el.value);

        if(el.id==="intStudentCount"){
          const n = clamp(+el.value||0, 0, 3);
          state.interview.studentCount = n;
          while(state.interview.students.length < n) state.interview.students.push({tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false});
          if(state.interview.students.length > n) state.interview.students = state.interview.students.slice(0,n);
        }

        saveState();
        updateTotals();
        renderIfNeeded(el);
      });
    });

    const addW2 = $('#addW2');
    if(addW2) addW2.onclick = ()=>{ state.w2s.push(defaultW2()); saveState(); render(); };
    $$('.removeW2', scope).forEach((btn,idx)=>{
      btn.onclick = ()=>{ state.w2s.splice(idx,1); if(!state.w2s.length) state.w2s=[defaultW2()]; saveState(); render(); };
    });

    const downloadSummary = $('#downloadSummary');
    if(downloadSummary) downloadSummary.onclick = ()=>{ preparePrint('summary'); };
    const downloadChecklist = $('#downloadChecklist');
    if(downloadChecklist) downloadChecklist.onclick = ()=>{ preparePrint('checklist'); };

    $$('[data-action="reset"]', scope).forEach(btn=>{
      btn.onclick = (e)=>{ e.preventDefault(); resetState(); };
    });

    const toggle = $('#toggleTotals');
    if(toggle){
      toggle.onclick = ()=>{
        const d = $('#totalsDrawer');
        const collapsed = d.classList.toggle('collapsed');
        toggle.textContent = collapsed ? "Show" : "Hide";
        toggle.setAttribute('aria-expanded', String(!collapsed));
      };
    }
  }

  function renderIfNeeded(el){
    if(!el) return;
    if(el.dataset.triggerRender) return render();

    const bind = el.dataset.bind || "";
    if(
      bind === "interview.hasDependents" ||
      bind === "interview.paidTuition" ||
      bind === "filingStatus"
    ){
      render();
    }

    // W-2 estimate toggles affect layout
    if(bind.includes("w2s.") && (bind.endsWith(".estimatingW2") || bind.endsWith(".estimatingWh") || bind.endsWith(".payType"))){
      render();
    }
  }

  function renderStep(step){
    switch(step){
      case "welcome":
        return `
          <h3 class="title">Welcome! Let’s estimate your federal refund.</h3>
          <div class="banner" role="note">
            <strong>2025 only.</strong>
            <div>
              W-2 jobs only. Federal estimate only. Not tax advice.
              <div class="help">You can add multiple W-2s. If you don’t have your W-2, use “Estimate my W-2” and we’ll still give a rough result.</div>
            </div>
          </div>

          <div class="info mt12" role="note">
            <strong>Important:</strong> This is a rough estimate. Exact refund depends on full eligibility rules, exact withholding (W-2 Box 2), and other income/credits not included.
          </div>

          <div class="hr"></div>

          <div class="pill">Standard Deduction & Brackets: 2025</div>
          <div class="help mt8">This estimator uses 2025 federal standard deduction, brackets, CTC/ACTC, EITC, and AOTC logic.</div>

          <div id="errorArea" class="mt8" tabindex="-1" aria-live="polite"></div>
        `;

      case "status":
        return `
          <h3 class="title">Filing Status & Ages</h3>
          <div class="row">
            <div class="radio-group" role="radiogroup" aria-label="Filing Status">
              ${["single","mfj","mfs","hoh","qw"].map(code=>{
                const label = {single:"Single", mfj:"Married Filing Jointly", mfs:"Married Filing Separately", hoh:"Head of Household", qw:"Qualifying Surviving Spouse"}[code];
                return `
                <label class="radio-option">
                  <input type="radio" name="filingStatus" data-bind="filingStatus" value="${code}" ${state.filingStatus===code?'checked':''} data-trigger-render="1">
                  <span>${label}</span>
                </label>`;
              }).join('')}
            </div>

            <div class="grid2">
              <div>
                <label for="ageT">Your age</label>
                <input id="ageT" type="number" min="0" max="120" data-bind="ages.taxpayer" value="${state.ages.taxpayer??''}">
                <div class="help">Age helps estimate extra standard deduction at 65+.</div>
              </div>
              ${state.filingStatus==="mfj" ? `
              <div>
                <label for="ageS">Spouse age</label>
                <input id="ageS" type="number" min="0" max="120" data-bind="ages.spouse" value="${state.ages.spouse??''}">
                <div class="help">Only needed for Joint filers.</div>
              </div>` : ''}
            </div>
          </div>

          ${state.filingStatus==="mfs" ? `
            <div class="info mt12">Note: Married Filing Separately often disqualifies or limits certain credits (like EITC and AOTC). This estimator reflects those limits.</div>
          ` : ''}

          <div id="errorArea" class="mt8" tabindex="-1" aria-live="polite"></div>
        `;

      case "income":
        return `
          <h3 class="title">Income — Add Your W-2(s)</h3>
          <div class="info" role="note">
            <strong>Easy option:</strong> If you don’t have your W-2, turn on <strong>“Estimate my W-2”</strong>. We’ll estimate wages + withholding (very rough).
          </div>

          <div class="row mt12">
            ${state.w2s.map((w,idx)=>`
              <div class="w2-row">
                <div class="space-between">
                  <div>
                    <strong>W-2 #${idx+1}</strong>
                    <div class="help">${w.estimatingW2 ? "Using estimate inputs" : "Using exact Box 1 / Box 2 (if entered)"}</div>
                  </div>
                  <button type="button" class="btn small secondary removeW2">Remove</button>
                </div>

                <div class="mt12">
                  <label class="radio-option" style="cursor:pointer">
                    <input type="checkbox" data-bind="w2s.${idx}.estimatingW2" ${w.estimatingW2?'checked':''} data-trigger-render="1">
                    <span><strong>Estimate my W-2 (I don’t have it)</strong></span>
                  </label>
                </div>

                <div class="grid3 mt12">
                  <div>
                    <label>Employer (optional)</label>
                    <input type="text" data-bind="w2s.${idx}.employer" value="${w.employer||''}" placeholder="(optional)">
                    <div class="help">Just for your reference.</div>
                  </div>

                  <div>
                    <label>Wages (Box 1) ${w.estimatingW2 ? '<span class="tip" title="Optional if you are estimating">i</span>' : ''}</label>
                    <input class="money" data-money="1" data-bind="w2s.${idx}.wages" value="${(w.wages?Number(w.wages).toLocaleString(): '')}" inputmode="numeric" placeholder="${w.estimatingW2 ? 'Leave blank if estimating' : ''}">
                    <div class="help">${w.estimatingW2 ? "If you know it, enter it. If not, we’ll estimate below." : "Use W-2 Box 1 (not Box 3/5)."}</div>
                  </div>

                  <div>
                    <label>Federal withheld (Box 2) <span class="tip" title="Optional — we can estimate if blank">i</span></label>
                    <input class="money" data-money="1" data-bind="w2s.${idx}.fedWh" value="${(w.fedWh?Number(w.fedWh).toLocaleString(): '')}" inputmode="numeric" placeholder="(optional)">
                    <div class="help">If blank, we can estimate withholding (rough).</div>
                  </div>
                </div>

                <div class="mt12">
                  <label class="radio-option" style="cursor:pointer">
                    <input type="checkbox" data-bind="w2s.${idx}.estimatingWh" ${w.estimatingWh?'checked':''} data-trigger-render="1">
                    <span>Estimate federal withholding if Box 2 is blank</span>
                  </label>
                  <div class="help">If you typed Box 2, we use it exactly. If it’s blank and this is on, we estimate.</div>
                </div>

                ${(w.estimatingW2) ? `
                  <div class="section mt12">
                    <p class="section-title"><strong>W-2 Estimate Inputs</strong></p>

                    <div class="grid3">
                      <div>
                        <label>Pay type</label>
                        <select data-bind="w2s.${idx}.payType" data-trigger-render="1">
                          <option value="hourly" ${w.payType==="hourly"?'selected':''}>Hourly</option>
                          <option value="salary" ${w.payType==="salary"?'selected':''}>Salary</option>
                        </select>
                        <div class="help">Choose what best matches your job.</div>
                      </div>

                      ${w.payType==="hourly" ? `
                        <div>
                          <label>Hourly rate</label>
                          <input type="number" min="0" step="0.01" data-bind="w2s.${idx}.hourlyRate" value="${+w.hourlyRate||0}">
                          <div class="help">Example: 18.50</div>
                        </div>
                        <div>
                          <label>Hours per week</label>
                          <input type="number" min="0" max="80" data-bind="w2s.${idx}.hoursPerWeek" value="${+w.hoursPerWeek||0}">
                          <div class="help">Example: 40</div>
                        </div>
                      ` : `
                        <div>
                          <label>Annual salary</label>
                          <input class="money" data-money="1" data-bind="w2s.${idx}.salaryAmount" value="${(+w.salaryAmount?Number(w.salaryAmount).toLocaleString(): '')}">
                          <div class="help">Before tax (gross).</div>
                        </div>
                        <div>
                          <label>Pay frequency</label>
                          <select data-bind="w2s.${idx}.payFrequency">
                            <option value="weekly" ${w.payFrequency==="weekly"?'selected':''}>Weekly</option>
                            <option value="biweekly" ${w.payFrequency==="biweekly"?'selected':''}>Biweekly</option>
                            <option value="semimonthly" ${w.payFrequency==="semimonthly"?'selected':''}>Twice a month</option>
                            <option value="monthly" ${w.payFrequency==="monthly"?'selected':''}>Monthly</option>
                          </select>
                          <div class="help">Used only for rough withholding behavior.</div>
                        </div>
                      `}
                    </div>

                    <div class="grid3 mt12">
                      <div>
                        <label>Months worked in 2025</label>
                        <input type="number" min="0" max="12" data-bind="w2s.${idx}.monthsWorked" value="${clamp(+w.monthsWorked||0,0,12)}">
                        <div class="help">If not sure, leave 12.</div>
                      </div>
                      <div>
                        <label>Did your job usually take federal taxes out?</label>
                        <select data-bind="w2s.${idx}.federalWithholdingUsuallyTaken">
                          <option value="yes" ${w.federalWithholdingUsuallyTaken==="yes"?'selected':''}>Yes</option>
                          <option value="no" ${w.federalWithholdingUsuallyTaken==="no"?'selected':''}>No</option>
                          <option value="unsure" ${w.federalWithholdingUsuallyTaken==="unsure"?'selected':''}>Not sure</option>
                        </select>
                        <div class="help">If you pick “No”, we estimate $0 withholding for this W-2.</div>
                      </div>
                      <div>
                        <label>Estimated wages (preview)</label>
                        <input type="text" value="${fmtMoney(effectiveWages(w))}" disabled>
                        <div class="help">We’ll use this for the estimate.</div>
                      </div>
                    </div>
                  </div>
                ` : ''}

              </div>
            `).join('')}

            <button id="addW2" class="btn small primary" type="button">Add another W-2</button>

            <div class="section mt12">
              <p class="section-title"><strong>Optional (leave blank if unsure)</strong></p>
              <div class="grid2">
                <div>
                  <label>Traditional IRA deduction</label>
                  <input class="money" data-money="1" data-bind="adjustments.iraDeduction" value="${(state.adjustments.iraDeduction?Number(state.adjustments.iraDeduction).toLocaleString(): '')}">
                  <div class="help">We cap this at ${fmtMoney(CONFIG_2025.adjustments.iraLimit)}.</div>
                </div>
                <div>
                  <label>Student loan interest</label>
                  <input class="money" data-money="1" data-bind="adjustments.studentLoanInterest" value="${(state.adjustments.studentLoanInterest?Number(state.adjustments.studentLoanInterest).toLocaleString(): '')}">
                  <div class="help">Max considered: ${fmtMoney(CONFIG_2025.adjustments.studentLoanInterestCap)}.</div>
                </div>
              </div>
              <div class="help mt8">If you’re not sure, leave these as 0. Your estimate still works.</div>
            </div>
          </div>

          <div id="errorArea" class="mt8" tabindex="-1" aria-live="polite"></div>
        `;

      case "interview":
        while(state.interview.students.length < 3) state.interview.students.push({tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false});
        return `
          <h3 class="title">Quick Credit Interview (Easy Mode)</h3>
          <div class="info" role="note">
            Answer a few simple questions. We’ll automatically check common credits and estimate them.
          </div>

          <div class="stack mt12">

            <div class="subcard">
              <p class="section-title"><strong>Kids / Dependents</strong></p>

              <label>Do you claim any kids or dependents?</label>
              <div class="radio-group mt8">
                <label class="radio-option">
                  <input type="radio" name="intHasDependents" data-bind="interview.hasDependents" value="yes"
                    ${state.interview.hasDependents==="yes"?'checked':''} data-trigger-render="1">
                  <span>Yes</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="intHasDependents" data-bind="interview.hasDependents" value="no"
                    ${state.interview.hasDependents==="no"?'checked':''} data-trigger-render="1">
                  <span>No</span>
                </label>
              </div>

              ${state.interview.hasDependents==="yes" ? `
                <div class="grid2 mt12">
                  <div>
                    <label>How many lived with you more than half the year?</label>
                    <input type="number" min="0" data-bind="interview.livedHalfCount" value="${+state.interview.livedHalfCount||0}">
                    <div class="help">Used for basic screening in this estimator.</div>
                  </div>
                  <div>
                    <label>How many were under 17 on Dec 31, 2025?</label>
                    <input type="number" min="0" data-bind="interview.under17Count" value="${+state.interview.under17Count||0}">
                    <div class="help">Under 17 is the main CTC rule.</div>
                  </div>
                </div>

                <div class="mt12">
                  <label>Do the kids you’re counting for CTC have Social Security numbers?</label>
                  <select data-bind="interview.kidsHaveSSN">
                    <option value="yes" ${state.interview.kidsHaveSSN==="yes"?'selected':''}>Yes</option>
                    <option value="no" ${state.interview.kidsHaveSSN==="no"?'selected':''}>No</option>
                    <option value="unsure" ${state.interview.kidsHaveSSN==="unsure"?'selected':''}>Not sure</option>
                  </select>
                  <div class="help">If you choose “No”, this estimator sets CTC to $0 (rules are strict).</div>
                </div>
              ` : `
                <div class="mt12">
                  <label>Kids have SSNs (CTC)</label>
                  <select data-bind="interview.kidsHaveSSN">
                    <option value="yes" ${state.interview.kidsHaveSSN==="yes"?'selected':''}>Yes</option>
                    <option value="no" ${state.interview.kidsHaveSSN==="no"?'selected':''}>No</option>
                    <option value="unsure" ${state.interview.kidsHaveSSN==="unsure"?'selected':''}>Not sure</option>
                  </select>
                  <div class="help">If you have no kids, this won’t matter.</div>
                </div>
              `}
            </div>

            <div class="subcard">
              <p class="section-title"><strong>Earned Income Credit (EITC)</strong></p>
              ${state.filingStatus==="mfs" ? `<div class="info">EITC is generally not allowed for Married Filing Separately. This estimator will show $0.</div>` : ''}

              <div class="mt12">
                <label>How many qualifying kids for EITC should we check?</label>
                <input type="number" min="0" data-bind="interview.eitcQualKids" value="${+state.interview.eitcQualKids||0}">
                <div class="help">If unsure, use the number who lived with you more than half the year.</div>
              </div>

              <div class="mt12">
                <label>Investment income (interest/dividends/stock profits) in 2025</label>
                <input class="money" data-money="1" data-bind="interview.investmentIncome" value="${(+state.interview.investmentIncome?Number(state.interview.investmentIncome).toLocaleString(): '')}">
                <div class="help">If this is over ${fmtMoney(CONFIG_2025.eitc.investmentIncomeLimit)}, EITC becomes $0.</div>
              </div>
            </div>

            <div class="subcard">
              <p class="section-title"><strong>College Tuition (AOTC)</strong></p>

              <label>Did you pay college tuition in 2025 (for you or a dependent)?</label>
              <div class="radio-group mt8">
                <label class="radio-option">
                  <input type="radio" name="intPaidTuition" data-bind="interview.paidTuition" value="yes"
                    ${state.interview.paidTuition==="yes"?'checked':''} data-trigger-render="1">
                  <span>Yes</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="intPaidTuition" data-bind="interview.paidTuition" value="no"
                    ${state.interview.paidTuition==="no"?'checked':''} data-trigger-render="1">
                  <span>No</span>
                </label>
              </div>

              ${state.interview.paidTuition==="yes" ? `
                <div class="grid2 mt12">
                  <div>
                    <label>Number of students</label>
                    <select id="intStudentCount" data-bind="interview.studentCount">
                      ${[0,1,2,3].map(n=>`<option value="${n}" ${(+state.interview.studentCount===n)?'selected':''}>${n}</option>`).join('')}
                    </select>
                    <div class="help">AOTC max is based on up to $4,000 qualified expenses per student.</div>
                  </div>
                  <div>
                    <label>Quick note</label>
                    <div class="info">AOTC isn’t allowed for Married Filing Separately (MFS).</div>
                  </div>
                </div>

                ${Array.from({length: clamp(+state.interview.studentCount||0,0,3)}).map((_,i)=>{
                  const st = state.interview.students[i] || {tuitionNet:0,yearsClaimed:0,halfTime:true,felony:false};
                  return `
                    <div class="w2-row mt12">
                      <p class="mb0"><strong>Student ${i+1}</strong></p>
                      <div class="grid3 mt8">
                        <div>
                          <label>Tuition paid (net)</label>
                          <input class="money" data-money="1" data-bind="interview.students.${i}.tuitionNet" value="${st.tuitionNet?Number(st.tuitionNet).toLocaleString():''}">
                          <div class="help">If unsure, estimate. We cap at $4,000 for max AOTC.</div>
                        </div>
                        <div>
                          <label>Years AOTC already claimed (0–3)</label>
                          <input type="number" min="0" max="3" data-bind="interview.students.${i}.yearsClaimed" value="${+st.yearsClaimed||0}">
                          <div class="help">AOTC is limited to 4 years total per student.</div>
                        </div>
                        <div>
                          <label>At least half-time?</label>
                          <select data-bind="interview.students.${i}.halfTime">
                            <option value="true" ${(st.halfTime===true || st.halfTime==="true")?'selected':''}>Yes</option>
                            <option value="false" ${(st.halfTime===false || st.halfTime==="false")?'selected':''}>No</option>
                          </select>
                          <div class="help">AOTC requires at least half-time for one academic period.</div>
                        </div>
                      </div>
                      <div class="mt8">
                        <label>Felony drug conviction before end of 2025?</label>
                        <select data-bind="interview.students.${i}.felony">
                          <option value="false" ${(st.felony===false || st.felony==="false")?'selected':''}>No</option>
                          <option value="true" ${(st.felony===true || st.felony==="true")?'selected':''}>Yes</option>
                        </select>
                        <div class="help">If “Yes,” that student isn’t eligible for AOTC.</div>
                      </div>
                    </div>
                  `;
                }).join('')}
              ` : ''}
            </div>

          </div>

          <div class="mt12 help">
            Next, we’ll calculate your estimate and show your estimated refund/owed amount.
          </div>

          <div id="errorArea" class="mt8" tabindex="-1" aria-live="polite"></div>
        `;

      case "results":
        const results = computeResults();
        const forms = buildFormsChecklist(state, results);
        return `
          <h3 class="title">Your Estimated Results</h3>
          <div class="chip">Tax Year 2025</div>
          <div class="chip">${labelFS(state.filingStatus)}</div>

          <div class="card print-section-summary" style="border:1px dashed #cfe8e4">
            ${renderSummary(results)}
          </div>

          <div class="card print-section-checklist" style="border:1px dashed #cfe8e4">
            <h4 class="mb0">Forms & Worksheets (Checklist)</h4>
            <ul id="formsList">${forms.map(f=>`<li>${f}</li>`).join('')}</ul>
          </div>

          <div class="controls space-between">
            <div>
              <button class="btn secondary" id="downloadSummary" type="button">Download Summary (PDF)</button>
              <button class="btn secondary" id="downloadChecklist" type="button">Download Forms Checklist (PDF)</button>
            </div>
            <div>
              <button class="btn link" type="button" data-action="reset">Start Over</button>
            </div>
          </div>

          <div class="info mt12">
            <strong>Reminder:</strong> This is an estimate only. If you didn’t enter W-2 Box 2, we estimated withholding and your refund could be higher or lower.
          </div>

          <div id="errorArea" class="mt8" tabindex="-1" aria-live="polite"></div>
        `;
    }
  }

  function renderSummary(r){
    const final = r.finalAmount;
    const finalLabel = final>=0 ? `<span class="kpi">${fmtMoney(final)} refund</span>` : `<span class="kpi">${fmtMoney(-final)} owed</span>`;
    const canvasId = "chart";
    setTimeout(()=> drawChart(canvasId, r), 0);

    const whNote = r.withholdingUsedEstimate
      ? `<div class="help mt8">Withholding includes an estimate of ${fmtMoney(r.withholdingEstimatedPart)} because Box 2 was blank on one or more W-2s.</div>`
      : `<div class="help mt8">Withholding is based on what you entered from W-2 Box 2.</div>`;

    const ctcNote = (r.ctc && r.ctc.note) ? `<div class="help mt8">${r.ctc.note}</div>` : "";

    return `
      <div class="grid2">
        <div>
          <div class="totals-grid">
            <div>Filing status</div><div class="kpi">${labelFS(state.filingStatus)}</div>
            <div>W-2 wages total (est.)</div><div class="kpi">${fmtMoney(r.wages)}</div>
            <div>Withholding total (est.)</div><div class="kpi">${fmtMoney(r.withholding)}</div>
            <div>AGI</div><div class="kpi">${fmtMoney(r.AGI)}</div>
            <div>Standard deduction</div><div class="kpi">${fmtMoney(r.stdDed)}</div>
            <div>Taxable income</div><div class="kpi">${fmtMoney(r.taxable)}</div>
            <div>Tax before credits</div><div class="kpi">${fmtMoney(r.taxBefore)}</div>

            <div>CTC (nonref / refundable)</div><div class="kpi">${fmtMoney(r.ctc.nonrefundable)} / ${fmtMoney(r.ctc.refundable)}</div>
            <div>AOTC (nonref / refundable)</div><div class="kpi">${fmtMoney(r.aotc.nonrefundable)} / ${fmtMoney(r.aotc.refundable)}</div>
            <div>EITC</div><div class="kpi">${fmtMoney(r.eitc)}</div>

            <div>Tax after nonrefundable credits</div><div class="kpi">${fmtMoney(r.taxAfterNonref)}</div>
            <div>Refundable credits total</div><div class="kpi">${fmtMoney(r.refundableTotal)}</div>
            <div>Total payments (withholding + refundable credits)</div><div class="kpi">${fmtMoney(r.totalPayments)}</div>
            <div><strong>Estimated result</strong></div><div class="kpi">${finalLabel}</div>
          </div>

          ${whNote}
          ${ctcNote}

          <div class="help mt12">
            This is a federal estimate based on your inputs. Exact results can differ (eligibility details, exact withholding, other income/credits, prior-year items).
          </div>
        </div>
        <div>
          <canvas id="${canvasId}" width="540" height="320" aria-label="Summary chart"></canvas>
        </div>
      </div>
    `;
  }

  function updateTotals(){
    const wages = sumWages(state.w2s);
    const AGI = calcAGI(state);
    const sd = calcStandardDeduction(state);
    const taxable = Math.max(0, AGI - sd);
    const taxBefore = calcTax(taxable, state.filingStatus||"single");

    const whCalc = computeEstimatedWithholding(taxBefore, state.w2s);

    $('#rtWages').textContent = fmtMoney(wages);
    $('#rtWh').textContent = fmtMoney(whCalc.total);
    $('#rtAGI').textContent = fmtMoney(AGI);
    $('#rtStdDed').textContent = fmtMoney(sd);

    const note = [];
    const anyEstimateW2 = state.w2s.some(w=>w.estimatingW2 && (Math.max(0,+w.wages||0)===0));
    if(anyEstimateW2) note.push("Some wages are estimated.");
    if(whCalc.usedEstimate) note.push("Some withholding is estimated (Box 2 blank).");
    $('#rtNote').textContent = note.length ? note.join(" ") : "";
  }

  function drawChart(id, results){
    const c = document.getElementById(id);
    if(!c) return;
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const data = [
      {label:"Tax", val: results.taxBefore},
      {label:"Nonref Credits", val: results.taxBefore - results.taxAfterNonref},
      {label:"Refundable Credits", val: results.refundableTotal},
      {label:"Withholding", val: results.withholding},
      {label:"Final", val: Math.abs(results.finalAmount)},
    ];
    const max = Math.max(...data.map(d=>d.val)) || 1;
    const pad = 30; const w=80; const gap=28;
    const baseY = c.height - 40;
    data.forEach((d,i)=>{
      const h = Math.round((d.val / max) * (c.height - 100));
      const x = pad + i*(w+gap);
      const y = baseY - h;
      ctx.fillStyle = ["#0f8f82","#87e0d6","#b6f0ea","#3fb4a8", results.finalAmount>=0 ? "#21a57f" : "#c55353"][i];
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = "#123";
      ctx.font = "12px system-ui";
      ctx.textAlign = "center";
      ctx.fillText(d.label, x+w/2, baseY+16);
      ctx.fillText(fmtMoney(d.val), x+w/2, y-6);
    });
  }

  /* ===========================
     RESULTS PIPELINE
     =========================== */
  function computeResults(){
    normalizeInterviewToState();

    const wages = sumWages(state.w2s);
    const AGI = calcAGI(state);
    const stdDed = calcStandardDeduction(state);
    const taxable = Math.max(0, AGI - stdDed);
    const taxBefore = calcTax(taxable, state.filingStatus||"single");

    // Withholding total (entered + estimated)
    const whCalc = computeEstimatedWithholding(taxBefore, state.w2s);
    const withholding = whCalc.total;

    const earnedIncome = wages;
    const MAGI = AGI;

    const ctc = state.creditsSelected.ctc
      ? calcCTC({
          MAGI,
          filingStatus: state.filingStatus||"single",
          eligibleUnder17: +state.dependents.under17||0,
          earnedIncome,
          taxBeforeCredits: taxBefore,
          kidsHaveSSN: state.interview.kidsHaveSSN
        })
      : {nonrefundable:0, refundable:0, note:""};

    const aotcRes = state.creditsSelected.aotc
      ? calcAOTC(
          (state.aotc.students||[]).slice(0,state.aotc.studentCount||0),
          MAGI,
          state.filingStatus||"single"
        )
      : {nonrefundable:0, refundable:0, disallowedReasons:[]};

    const eitcAmt = state.creditsSelected.eitc
      ? calcEITC(
          earnedIncome,
          AGI,
          state.filingStatus||"single",
          +state.dependents.eitcChildren||0,
          +state.eitc.investmentIncome||0
        )
      : 0;

    const ord = orderCredits(
      { taxBefore },
      [ctc.nonrefundable, aotcRes.nonrefundable],
      [ctc.refundable, aotcRes.refundable, eitcAmt]
    );

    const totalPayments = withholding + ord.refundableTotal;
    const finalAmount = totalPayments - ord.taxAfterNonref;

    return {
      wages,
      withholding,
      withholdingUsedEstimate: !!whCalc.usedEstimate,
      withholdingEstimatedPart: Math.round(whCalc.estimatedPart||0),

      AGI, stdDed, taxable, taxBefore,
      ctc, aotc: aotcRes, eitc: eitcAmt,
      taxAfterNonref: ord.taxAfterNonref,
      refundableTotal: ord.refundableTotal,
      totalPayments, finalAmount
    };
  }

  /* ===========================
     PRINT
     =========================== */
  function preparePrint(which){
    const body = document.body;
    body.classList.remove('print-scope-summary','print-scope-checklist');
    body.classList.add(which==='summary' ? 'print-scope-summary' : 'print-scope-checklist');
    setTimeout(()=>{ window.print(); setTimeout(()=>{ body.classList.remove('print-scope-summary','print-scope-checklist'); }, 50); }, 10);
  }

  /* ===========================
     FOOTER (wire once)
     =========================== */
  function wireFooterOnce(){
    const back = document.getElementById("backBtn");
    const next = document.getElementById("nextBtn");
    const reset = document.getElementById("startOverBtn");

    if(back && !back.dataset.wired){
      back.dataset.wired = "1";
      back.addEventListener("click", (e)=>{ e.preventDefault(); goBack(); }, true);
    }
    if(next && !next.dataset.wired){
      next.dataset.wired = "1";
      next.addEventListener("click", (e)=>{ e.preventDefault(); goNext(); }, true);
    }
    if(reset && !reset.dataset.wired){
      reset.dataset.wired = "1";
      reset.addEventListener("click", (e)=>{ e.preventDefault(); resetState(); }, true);
    }
  }

  /* ===========================
     INIT
     =========================== */
  (function mount(){
    wireFooterOnce();
    render();
  })();
  </script>

</body>
</html>

